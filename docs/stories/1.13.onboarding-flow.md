# Story 1.13: Onboarding Flow with User State Branching

## Status
Draft

## Story
**As a** new or existing user,  
**I want** to complete an onboarding flow tailored to my data state,  
**so that** I can set up my web app experience appropriately.

## Acceptance Criteria
1. **Steps 1-6** (All users - DEPRECATED, see AC note below):
   - Personal Info, Frequency, Duration, Experience, Goals, Equipment
   - Each answer tracked via Amplitude event
   - Progress bar shows "X of 9" (new users) or "X of 6" (existing users)
   - Skip button available on every step
2. **After Step 6**: Check user data state
3. **Existing users**:
   - Show transition: "Welcome back! Your programs from mobile are ready."
   - Redirect to dashboard
   - Analytics: "Onboarding Completed" (userState: 'existing', completedSteps: 6)
4. **New users**:
   - Continue to Step 7 (Program Setup)
   - Steps 7-9: Choose program path (describe, build, select recommended)
   - Analytics: "Onboarding Completed" (userState: 'new', completedSteps: 9, programSetup: string)
5. **Onboarding answers NOT persisted to backend** (Amplitude events only)

**âš ï¸ CRITICAL AC UPDATE from User Flows v2.1**:
- **Existing users**: Skip ALL onboarding (not 6 steps) - Go directly to dashboard after login
- **New users**: Complete full 9-step onboarding
- **Branching happens**: At login/signup (BEFORE any onboarding), not after Step 6

## Integration Verification
- IV1: User state branching works correctly (existing users skip to dashboard)
- IV2: All analytics events fire correctly
- IV3: Skip functionality works at any step

## Tasks / Subtasks

### Task 1: Implement User State Branching at Login/Signup (AC Updated, IV1)
- [ ] Update post-auth redirect logic
  - [ ] After successful login/signup, check user data state
  - [ ] If state === 'existing': Redirect to `/app` (skip all onboarding)
  - [ ] If state === 'new': Redirect to `/app/onboarding/profile` (Step 1)
  - [ ] Fire analytics: "User Data State Detected" with redirect path
- [ ] Update `components/auth/LoginForm.tsx` and `SignupForm.tsx`
  - [ ] Add user state detection after auth success
  - [ ] Implement branching logic
  - [ ] No onboarding for existing users (simpler UX)

### Task 2: Create Onboarding Layout (AC: 1, IV3)
- [ ] Create `app/app/onboarding/layout.tsx`
  - [ ] Progress indicator component (9 dots)
  - [ ] Skip button (top-right)
  - [ ] Back button (top-left, except Step 1)
  - [ ] Centered content area (max-width: 600px)
- [ ] Create `components/onboarding/OnboardingProgress.tsx`
  - [ ] 9 progress dots (circles)
  - [ ] Current step filled (blue/orange)
  - [ ] Future steps empty (gray outline)
  - [ ] "X of 9" text below dots

### Task 3: Create Onboarding Steps 1-6 (AC: 1)
- [ ] Step 1: Create `/app/onboarding/profile/page.tsx`
  - [ ] Gender selection (radio buttons: Male, Female, Other, Prefer not to say)
  - [ ] Age range dropdown (18-25, 26-35, 36-45, 46-55, 56+)
  - [ ] Next button (navigate to Step 2)
  - [ ] Analytics: "Onboarding Step Completed" (step: 1, gender, ageRange)
  
- [ ] Step 2: Create `/app/onboarding/frequency/page.tsx`
  - [ ] Training frequency cards (1-2, 3-4, 5-6, 7+ times/week)
  - [ ] Single-select cards with icons
  - [ ] Next button â†’ Step 3
  - [ ] Analytics: "Onboarding Step Completed" (step: 2, frequency)
  
- [ ] Step 3: Create `/app/onboarding/duration/page.tsx`
  - [ ] Duration cards (30min or less, 30-45, 45-60, 60+)
  - [ ] Single-select cards
  - [ ] Next button â†’ Step 4
  - [ ] Analytics: "Onboarding Step Completed" (step: 3, duration)
  
- [ ] Step 4: Create `/app/onboarding/experience/page.tsx`
  - [ ] Experience cards (Beginner, Intermediate, Advanced, Expert)
  - [ ] Single-select cards with descriptions
  - [ ] Next button â†’ Step 5
  - [ ] Analytics: "Onboarding Step Completed" (step: 4, experience)
  
- [ ] Step 5: Create `/app/onboarding/goals/page.tsx`
  - [ ] Goal cards (Build Muscle, Strength, Lose Weight, Endurance, General Fitness, Athletic Performance)
  - [ ] Multi-select cards (2Ã—3 grid)
  - [ ] Checkboxes in top-right corner
  - [ ] Next button (enabled after â‰¥1 selection) â†’ Step 6
  - [ ] Analytics: "Onboarding Step Completed" (step: 5, goals: string[])
  
- [ ] Step 6: Create `/app/onboarding/equipment/page.tsx`
  - [ ] Equipment cards (Free Weights, Machines, Resistance Bands, Bodyweight, Cardio, Other)
  - [ ] Multi-select cards (2Ã—3 grid)
  - [ ] Next button (enabled after â‰¥1 selection) â†’ Step 7
  - [ ] Analytics: "Onboarding Step Completed" (step: 6, equipment: string[])

### Task 4: Create Onboarding Steps 7-9 (NEW USERS ONLY) (AC: 4)
- [ ] Step 7: Create `/app/onboarding/program/page.tsx`
  - [ ] Question: "Do you already have a training program?"
  - [ ] Two options: "Yes, I have a program" and "No, I need a program"
  - [ ] If "Yes": Navigate to Step 8a (Describe Program)
  - [ ] If "No": Navigate to Step 8b (Program Recommendations)
  - [ ] Skip option: Navigate directly to dashboard
  - [ ] Analytics: "Onboarding Step Completed" (step: 7, hasProgramResponse: boolean)
  
- [ ] Step 8a: Create `/app/onboarding/describe-program/page.tsx`
  - [ ] Large text area for program description (2000 char max)
  - [ ] Voice input button (ğŸ¤) for transcription
  - [ ] Character counter
  - [ ] Primary CTA: "Create My Program" (AI processing)
  - [ ] Secondary link: "Use Program Builder instead" â†’ Program Builder
  - [ ] Analytics: "Onboarding Program Described" (descriptionLength, usedVoice: boolean)
  
- [ ] Step 8b: Create `/app/onboarding/recommendations/page.tsx`
  - [ ] Display 3-4 recommended programs (based on Steps 1-6 answers)
  - [ ] Program cards: Name, duration, frequency, focus, preview
  - [ ] "Select This Program" button on each
  - [ ] Secondary CTAs: "Browse All" and "Build My Own"
  - [ ] Analytics: "Onboarding Program Recommendations Viewed" (programCount)
  
- [ ] Step 9: Program confirmation/review
  - [ ] If from AI: Show generated program, allow edit
  - [ ] If from recommendations: Show selected program details
  - [ ] "Save & Continue" â†’ Dashboard
  - [ ] Analytics: "Onboarding Program Confirmed" (source: 'ai' | 'recommendation' | 'manual')

### Task 5: Implement Skip Functionality (AC: 1, IV3)
- [ ] Add Skip button to all steps
  - [ ] Top-right corner
  - [ ] Link style (not button)
  - [ ] Text: "Skip for now â†’"
  - [ ] Color: Orange (#FF6B2C from mobile app)
  - [ ] Click â†’ Navigate to dashboard
  - [ ] Analytics: "Onboarding Step Skipped" (step: number)
- [ ] Implement skip from any step
  - [ ] User can skip at Step 1, 2, 3... 9
  - [ ] Always navigates to dashboard
  - [ ] Dashboard shows appropriate empty states

### Task 6: Implement Back Navigation
- [ ] Add Back arrow to all steps except Step 1
  - [ ] Top-left corner
  - [ ] Icon: Left arrow
  - [ ] Click â†’ Navigate to previous step
  - [ ] Preserve previously selected answers
  - [ ] Analytics: "Onboarding Step Back" (fromStep, toStep)

### Task 7: Store Onboarding Answers (Local State Only) (AC: 5)
- [ ] Create onboarding state context
  - [ ] Store answers in React state (NOT localStorage)
  - [ ] Pass state through onboarding flow
  - [ ] DO NOT persist to backend (Amplitude only)
  - [ ] Clear state after dashboard redirect or skip
- [ ] Answers used only for:
  - Program recommendations (Steps 8-9)
  - Analytics tracking

### Task 8: Implement Analytics Funnel (AC: 1, 3, 4, IV2)
- [ ] Add analytics events for complete funnel
  - [ ] "Onboarding Started" (userState: 'new', totalSteps: 9)
  - [ ] "Onboarding Step Viewed" (step: number) - Each step
  - [ ] "Onboarding Step Completed" (step: number, answer: any) - Each step
  - [ ] "Onboarding Step Skipped" (step: number)
  - [ ] "Onboarding Step Back" (fromStep, toStep)
  - [ ] "Onboarding Completed" (userState: 'new', completedSteps: 9, programSetup: string, timeToComplete: seconds)
  - [ ] "Onboarding Abandoned" (lastStep: number, answersCompleted: number)

### Task 9: Testing
- [ ] Write unit tests for user state branching
  - [ ] Test: New user â†’ Redirects to onboarding
  - [ ] Test: Existing user â†’ Redirects to dashboard (skips onboarding)
  - [ ] Test: Unknown state â†’ Defaults to dashboard (fail-safe)
- [ ] Write integration tests for onboarding flow
  - [ ] Test: Complete all 9 steps â†’ Dashboard
  - [ ] Test: Skip at Step 3 â†’ Dashboard
  - [ ] Test: Back navigation â†’ Returns to previous step
  - [ ] Test: Progress indicator updates
  - [ ] Test: Answers stored in context
  - [ ] Test: Analytics events fire at each step
- [ ] Write E2E test for complete onboarding
  - [ ] Test: Signup â†’ Onboarding (9 steps) â†’ Program setup â†’ Dashboard
  - [ ] Test: Login (existing user) â†’ Dashboard (no onboarding)

## Dev Notes

### ğŸ”§ Developer Setup Reference
**Development Prerequisites**: Complete Stories 1.1-1.12 (especially 1.2 for user state)
- **Setup Guide**: `docs/DEVELOPER_SETUP.md`
- **Dependencies**: Amplitude SDK (installed), React Context API
- **Branch**: `feature/story-1.13-onboarding-flow`

**Source**: [DEVELOPER_SETUP.md]

### ğŸ“ User Flow & Wireframe References
**User Flow**: Onboarding ONLY for new users (critical MVP constraint)
- **Flow Reference**: `docs/web-app-user-flows.md` - Sections "New User Journey" and "User Data State & Flow Branching"
- **Wireframe**: `docs/wireframes.md` - Section 1 (Complete onboarding flow, Steps 1.1-1.11)

**Critical Branching Logic** (UPDATED in v2.1):
- **After Login/Signup**: System checks user data state immediately
- **Existing user** â†’ Skip ALL onboarding â†’ Direct to dashboard
- **New user** â†’ Show full 9-step onboarding â†’ Dashboard

**Why Existing Users Skip Everything**:
- Already onboarded on mobile app
- Repeating questions is redundant and annoying
- Faster time to value (straight to their data)

**Onboarding Steps** (NEW USERS ONLY):
1. Personal Info (Gender, Age)
2. Training Frequency (1-2, 3-4, 5-6, 7+ days/week)
3. Training Duration (30min or less, 30-45, 45-60, 60+)
4. Experience Level (Beginner, Intermediate, Advanced, Expert)
5. Goals (Multi-select: Build Muscle, Strength, etc.)
6. Equipment Available (Multi-select: Free Weights, Machines, etc.)
7. Program Setup (Do you have a program? Yes/No/Skip)
8-9. Program configuration (varies by Step 7 answer)

**Source**: [web-app-user-flows.md - Flow 1: New User Journey, User Data State & Flow Branching, wireframes.md - Section 1]

### ğŸ¨ Wireframes for Implementation

#### Onboarding Step 1: Personal Info
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [EZLift Logo]                                            [Skip for now â†’]  â”‚
â”‚                                                                              â”‚
â”‚                    â— â—‹ â—‹ â—‹ â—‹ â—‹ â—‹ â—‹ â—‹                                        â”‚
â”‚                         1 of 9                                              â”‚
â”‚                                                                              â”‚
â”‚                        Tell us about yourself                               â”‚
â”‚                    This helps us personalize your experience                â”‚
â”‚                                                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚  Gender                                â”‚                     â”‚
â”‚              â”‚  â—‹ Male    â—‹ Female    â—‹ Other         â”‚                     â”‚
â”‚              â”‚            â—‹ Prefer not to say         â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚  Age Range                             â”‚                     â”‚
â”‚              â”‚  [Select age range â–¾]                  â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚              [Next â†’]                  â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Onboarding Step 2: Training Frequency
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† Back]  [EZLift Logo]                                  [Skip for now â†’]  â”‚
â”‚                                                                              â”‚
â”‚                    â— â— â—‹ â—‹ â—‹ â—‹ â—‹ â—‹ â—‹                                        â”‚
â”‚                         2 of 9                                              â”‚
â”‚                                                                              â”‚
â”‚                       How often do you train?                               â”‚
â”‚                   We'll use this to recommend programs                      â”‚
â”‚                                                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚  ğŸ“…  1-2 times per week           â—‹    â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚  ğŸ“…  3-4 times per week           â—‹    â”‚ â† Most common       â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚  ğŸ“…  5-6 times per week           â—‹    â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚  ğŸ“…  7+ times per week (Daily)    â—‹    â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚              [Next â†’]                  â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Onboarding Step 5: Goals (Multi-Select)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† Back]  [EZLift Logo]                                  [Skip for now â†’]  â”‚
â”‚                                                                              â”‚
â”‚                    â— â— â— â— â— â—‹ â—‹ â—‹ â—‹                                        â”‚
â”‚                         5 of 9                                              â”‚
â”‚                                                                              â”‚
â”‚                     What are your primary goals?                            â”‚
â”‚                          Select all that apply                              â”‚
â”‚                                                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚  ğŸ’ª                 â”‚  â”‚  ğŸ‹ï¸                 â”‚                     â”‚
â”‚         â”‚  Build Muscle      â”‚  â”‚  Increase Strength â”‚                     â”‚
â”‚         â”‚                 â˜‘  â”‚  â”‚                 â˜  â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚  âš–ï¸                 â”‚  â”‚  ğŸƒ                 â”‚                     â”‚
â”‚         â”‚  Lose Weight       â”‚  â”‚  Improve Endurance â”‚                     â”‚
â”‚         â”‚                 â˜  â”‚  â”‚                 â˜  â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚  â­                 â”‚  â”‚  ğŸ†                 â”‚                     â”‚
â”‚         â”‚  General Fitness   â”‚  â”‚  Athletic Perform. â”‚                     â”‚
â”‚         â”‚                 â˜  â”‚  â”‚                 â˜  â”‚                     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚              [Next â†’]                  â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Onboarding Step 7: Program Setup (NEW USERS ONLY)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† Back]  [EZLift Logo]                                  [Skip for now â†’]  â”‚
â”‚                                                                              â”‚
â”‚                    â— â— â— â— â— â— â— â—‹ â—‹                                        â”‚
â”‚                         7 of 9                                              â”‚
â”‚                                                                              â”‚
â”‚                  Do you already have a training program?                    â”‚
â”‚                    We can help you get started either way                   â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚         â”‚  âœ… Yes, I have a program                                  â”‚     â”‚
â”‚         â”‚     Describe it and we'll set it up for you               â”‚     â”‚
â”‚         â”‚                                                            â”‚     â”‚
â”‚         â”‚                                                       [â†’]  â”‚     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚         â”‚  ğŸ“‹ No, I need a program                                   â”‚     â”‚
â”‚         â”‚     We'll suggest programs based on your goals             â”‚     â”‚
â”‚         â”‚                                                            â”‚     â”‚
â”‚         â”‚                                                       [â†’]  â”‚     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Design Specs** (From mobile app patterns):

**Progress Indicator**:
- 9 dots total for new users
- Current dot: Filled circle, blue/orange (#FF6B2C)
- Future dots: Empty circles, gray outline
- Size: 12px diameter, 8px gap
- Below: "X of 9" text (14px, gray)

**Card Design** (Single-select and multi-select):
- Width: Full-width in container (max 500px)
- Height: 72px (single-select), 140px (multi-select grid)
- Padding: 16px
- Border: 2px solid gray (#e5e7eb)
- Border-radius: 12px
- Hover: Light blue background, blue border
- Selected: Blue background (#2563eb or #eff6ff), blue border, white text
- Icon: 24px (single-select), 48px (multi-select)
- Radio/Checkbox: Right side (single), top-right corner (multi)

**Buttons**:
- Next button: Full-width, 48px height, orange (#FF6600), **black text** for better readability
- Skip link: Top-right, 14px, orange (#FF6600), underline on hover
- Back arrow: Top-left, 24px, gray

**Colors** (From mobile app):
- Primary action: Orange (#FF6B2C)
- Selected state: Blue (#2563eb) or light blue (#eff6ff)
- Text: Dark gray (#1f2937)
- Subtext: Medium gray (#6b7280)

**Source**: [wireframes.md - Sections 1.2-1.8, Onboarding design patterns]

### Post-Auth Redirect Logic
**Critical Branching** (Happens BEFORE any onboarding):
```typescript
// lib/auth/post-auth-redirect.ts
import { useUserDataState } from '@/hooks/useUserDataState';

export async function handlePostAuthRedirect(userId: string) {
  // Detect user data state
  const userState = await detectUserDataState(userId);
  
  if (userState === 'existing') {
    // Existing user: NO onboarding at all
    analytics.track('User Data State Detected', {
      state: 'existing',
      hasWorkouts: true,
      redirectTo: 'dashboard_direct'
    });
    
    analytics.track('Onboarding Skipped', {
      reason: 'existing_user',
      hasWorkouts: true,
      hasSessions: true
    });
    
    router.push('/app');  // Direct to dashboard
    
  } else {
    // New user: Start full 9-step onboarding
    analytics.track('User Data State Detected', {
      state: 'new',
      redirectTo: 'onboarding'
    });
    
    analytics.track('Onboarding Started', {
      userState: 'new',
      totalSteps: 9
    });
    
    router.push('/app/onboarding/profile');  // Step 1
  }
}

// Usage in login/signup success handlers
async function onLoginSuccess(user: User) {
  await handlePostAuthRedirect(user.id);
}
```

**Source**: [User Flows v2.1 - Critical Branching Point, Component Architecture - Onboarding Components]

### Onboarding State Management
**Context Pattern** (NOT persisted to backend):
```typescript
// contexts/OnboardingContext.tsx
import { createContext, useContext, useState } from 'react';

interface OnboardingData {
  step1?: { gender?: string; ageRange?: string };
  step2?: { frequency?: string };
  step3?: { duration?: string };
  step4?: { experience?: string };
  step5?: { goals?: string[] };
  step6?: { equipment?: string[] };
  step7?: { hasProgram?: boolean };
  step8?: { programDescription?: string } | { selectedProgramId?: string };
}

const OnboardingContext = createContext<{
  data: OnboardingData;
  updateData: (step: keyof OnboardingData, value: any) => void;
} | null>(null);

export function OnboardingProvider({ children }: { children: React.ReactNode }) {
  const [data, setData] = useState<OnboardingData>({});
  
  const updateData = (step: keyof OnboardingData, value: any) => {
    setData(prev => ({ ...prev, [step]: value }));
    
    // Fire analytics for each step completion
    analytics.track('Onboarding Step Completed', {
      step: parseInt(step.replace('step', '')),
      answer: value
    });
  };
  
  return (
    <OnboardingContext.Provider value={{ data, updateData }}>
      {children}
    </OnboardingContext.Provider>
  );
}

export function useOnboardingData() {
  const context = useContext(OnboardingContext);
  if (!context) {
    throw new Error('useOnboardingData must be used within OnboardingProvider');
  }
  return context;
}
```

**Why NOT Persisted**:
- Answers used only for analytics (Amplitude)
- Used temporarily for program recommendations
- No backend storage needed (reduces complexity)
- Cleared after onboarding complete

**Source**: [Epic 1.13 AC 5, State Management]

### Program Setup Paths (Steps 7-9)
**Path A: "Yes, I have a program"**
1. Step 7: User selects "Yes"
2. Step 8: Auto-navigate to Describe Program screen
   - Text area for description
   - Voice input option
   - "Create My Program" (AI processes)
   - Secondary: "Use Program Builder instead" link
3. Step 9: Review AI-generated program
   - Allow edits
   - "Save & Continue" â†’ Dashboard

**Path B: "No, I need a program"**
1. Step 7: User selects "No"
2. Step 8: Auto-navigate to Program Recommendations
   - Show 3-4 programs (based on Steps 1-6)
   - "Select This Program" buttons
3. Step 9: Confirm selected program
   - Show program details
   - "Confirm & Continue" â†’ Dashboard

**Path C: "Skip for now"**
1. Step 7: User clicks "Skip"
2. Direct to dashboard (no Steps 8-9)
3. Dashboard shows empty state with program creation CTAs

**Source**: [User Flows - Onboarding Steps 7-9, wireframes.md - Section 1.8-1.11]

### ğŸ¨ Design System Reference
**ğŸ”´ CRITICAL DEPENDENCY**: Story 1.0 (Design System Foundation) MUST be complete first!

**Design System**: `docs/design-system.md` (created in Story 1.0)  
**UX Design Brief**: `docs/ux-design-brief.md` - Mobile App Design System (lines 973-1093)

**Onboarding Visual Design**:

**Page Background**: Light gray (#F5F5F5) or white - Clean, minimal

**Progress Indicator** (Top of every step):
- Dots: 12px diameter, 8px gap between
- Current dot: Filled orange (#FF6600) or blue (#0B87D9)
- Future dots: Empty circles, gray outline (#E0E0E0)
- "X of 9" text: 14px, gray (#757575), centered below dots

**Typography**:
- Question heading: 32px, bold (#1A1A1A), centered
- Subheading: 16px, regular, gray (#757575), centered
- Card text: 18px, regular (#1A1A1A)
- Card subtext: 14px, gray (#757575)

**Button Styles** (from mobile app):
- **Next Button**: Orange (#FF6600), **black text** for better readability, 56px height, rounded 12-16px, full-width
- **Skip Link**: Orange (#FF6600) text, 14px, top-right, underline on hover
- **Back Arrow**: Gray icon, 24px, top-left, clickable

**Option Cards** (Single-Select):
- Size: Full-width (max 500px), 72px height
- Padding: 16px
- Border: 2px solid gray (#E0E0E0)
- Border-radius: 12px
- **Unselected**: White background, gray border, gray text
- **Hover**: Light blue background (#eff6ff), blue border (#2563eb)
- **Selected**: Blue background (#2563eb), white text, blue border, radio filled
- Icon: 24px, left side
- Radio button: 20px, right side

**Option Cards** (Multi-Select Grid - Goals, Equipment):
- Size: 220px Ã— 140px per card
- Grid: 2 columns Ã— 3 rows
- Gap: 20px horizontal and vertical
- Icon: 48px, centered at top
- Label: 16px, centered below icon
- **Unselected**: Light gray background (#F3F4F6), gray border
- **Selected**: Blue background (#2563eb), white text, checkmark top-right corner (24px)

**Input Fields**:
- Background: White
- Border: 1px solid gray (#E0E0E0)
- Border-radius: 12px
- Height: 52px
- Padding: 12px 16px
- Font: 16px, regular
- Placeholder: Gray text (#BDBDBD)

**Large Text Area** (Describe Program):
- Width: 600px (desktop)
- Height: 300px
- Border: 2px solid gray, rounded 12px
- Character counter: 14px, gray, bottom-right

**Centered Layout**:
- Max-width: 600px
- Centered horizontally
- Padding: 32px (desktop), 16px (mobile)
- Generous vertical spacing (32px between sections)

**Source**: [ux-design-brief.md - Mobile App Design System, Component Styles (lines 1019-1068), Interaction Patterns (lines 1096-1113)]

### Testing Requirements

**Unit Tests** (Jest):
- User state branching logic
- Onboarding context state management
- Progress calculation
- Skip and back navigation

**Integration Tests** (Testing Library):
- Complete onboarding flow (all 9 steps)
- Skip at various steps
- Back navigation
- User state branching (new vs existing)
- Analytics events fire

**E2E Test** (Recommended):
- Signup â†’ Onboarding â†’ Program setup â†’ Dashboard
- Login (existing user) â†’ Dashboard (no onboarding)

**Test File Locations**:
- `__tests__/lib/auth/post-auth-redirect.test.ts`
- `__tests__/contexts/OnboardingContext.test.tsx`
- `__tests__/components/onboarding/*.test.tsx` (one per step)
- `__tests__/integration/onboarding-flow.test.tsx`
- `__tests__/e2e/complete-onboarding.test.ts`

**Source**: [Testing Strategy - Unit Tests, Integration Tests, E2E Tests]

### Analytics Event Schema
**Complete Onboarding Funnel**:
```typescript
// Event 1: Onboarding started
analytics.track('Onboarding Started', {
  userState: 'new',
  totalSteps: 9,
  timestamp: string
});

// Event 2-7: Each step viewed
analytics.track('Onboarding Step Viewed', {
  step: number,  // 1-9
  timestamp: string
});

// Event 2-7: Each step completed
analytics.track('Onboarding Step Completed', {
  step: number,
  answer: any,  // Varies by step
  timestamp: string
});

// Event: Skip
analytics.track('Onboarding Step Skipped', {
  step: number,
  answersCompleted: number
});

// Event: Back navigation
analytics.track('Onboarding Step Back', {
  fromStep: number,
  toStep: number
});

// Event: Onboarding complete
analytics.track('Onboarding Completed', {
  userState: 'new',
  completedSteps: number,  // 9 if all, less if skipped
  programSetup: 'ai_described' | 'manual_builder' | 'recommended' | 'skipped',
  timeToComplete: number,  // seconds
  timestamp: string
});

// Event: Abandoned
analytics.track('Onboarding Abandoned', {
  lastStep: number,
  answersCompleted: number,
  timestamp: string
});

// Event: Existing user skip (at login)
analytics.track('Onboarding Skipped', {
  reason: 'existing_user',
  hasWorkouts: boolean,
  hasSessions: boolean
});
```

**Source**: [Analytics Integration - Event Taxonomy, Event Tracking Strategy]

### Critical Implementation Notes
1. **User state check happens FIRST** (at login/signup, not after Step 6)
2. **Existing users NEVER see any onboarding** (improved UX in v2.1)
3. **Answers NOT saved to database** (Amplitude events only)
4. **Skip available on every step** (orange button, top-right)
5. **Back navigation available** (except Step 1)
6. **Progress accurate**: "X of 9" for new users
7. **Mobile app colors**: Orange (#FF6B2C) for actions, Blue (#2563eb) for selections

## Testing

### Test Coverage Requirements
- Unit test coverage: > 85% for state management and navigation
- Integration test coverage: Complete onboarding flow
- E2E test: Full user journey (signup â†’ onboarding â†’ dashboard)

### Test Scenarios
1. **New User Complete Flow**: Signup â†’ 9 steps â†’ Program setup â†’ Dashboard
2. **Existing User Skip**: Login â†’ User state detected â†’ Skip to dashboard (no onboarding)
3. **Skip at Step 3**: Start â†’ Step 1, 2, 3 â†’ Skip â†’ Dashboard
4. **Back Navigation**: Step 5 â†’ Back â†’ Step 4 (answers preserved)
5. **Multi-Select**: Goals step â†’ Select 3 goals â†’ Saved correctly
6. **Program Path A**: "Yes, I have program" â†’ Describe â†’ AI creates â†’ Dashboard
7. **Program Path B**: "No program" â†’ Recommendations â†’ Select â†’ Dashboard
8. **Program Path C**: "Skip" â†’ Dashboard empty state
9. **Analytics Funnel**: All events fire at correct stages
10. **State Management**: Answers stored in context, not backend

### Performance Targets
- Step navigation: < 100ms
- Progress indicator update: Instant
- Analytics event firing: Non-blocking
- Skip/back actions: Instant

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation with complete references and v2.1 user flow updates | Bob (SM) |

## Dev Agent Record
*(To be populated by dev agent during implementation)*

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

## QA Results
*(To be populated by QA agent after dev completion)*

