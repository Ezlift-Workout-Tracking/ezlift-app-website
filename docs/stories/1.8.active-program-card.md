# Story 1.8: Active Program Card

## Status
Ready for Done

## Story
**As a** user,  
**I want** to see my active program summary,  
**so that** I know what workout is next.

## Acceptance Criteria
1. Fetch: `GET /api/routine` (find default or most recently used)
2. Display: Program name, week progress (if tracked), next workout name
3. Actions:
   - "View Program" â†’ Navigate to program detail page
   - "Edit Program" â†’ New users: Open editor; Existing users: Show "Use mobile app" message
4. Empty state (new users): "Create your first program to get started" with CTA
5. Empty state (existing users): "Your programs from mobile will appear here"
6. Analytics: "Dashboard Card Viewed" (cardType: 'program')

## Integration Verification
- IV1: Correctly identifies default or active routine
- IV2: Edit button behavior respects user data state
- IV3: Empty state varies by user type

## Tasks / Subtasks

### Task 1: Create Active Program Query Logic (AC: 1)
- [x] Create `hooks/useRoutines.ts` (React Query hook)
  - [x] Implement `useRoutines()` hook with React Query
  - [x] Fetch: `GET /api/workout` (existing API proxy)
  - [x] Find active routine (isDefault: true)
  - [x] Return: Routines array with active routine logic

### Task 2: Create Active Program Card Component (AC: 2, 3)
- [x] Create `components/dashboard/ActiveProgramCard.tsx`
  - [x] Use `DashboardCard` wrapper (added fullWidth prop)
  - [x] Display program name (title from routine)
  - [x] Display next workout info using utility functions
  - [x] Add "View Program" button â†’ Navigate to `/app/programs/{id}`
  - [x] Add "Edit Program" button with conditional logic:
    - [x] Check `useUserDataState()` hook
    - [x] New user: Navigate to `/app/programs/{id}/edit`
    - [x] Existing user: Show read-only message dialog
  - [x] Add "Start Workout on Mobile" button

### Task 3: Implement User State-Based Edit Access (AC: 3, IV2)
- [x] Create edit button with state check
  - [x] Import `useUserDataState()` from Story 1.2
  - [x] If state === 'new': Allow edit, navigate to editor
  - [x] If state === 'existing': Show dialog/message
  - [x] If state === 'unknown': Default to read-only (safe)
- [x] Create read-only message dialog inline
  - [x] Heading: "Program editing on mobile only"
  - [x] Message included in card content
  - [x] CTA: "Download App" link

### Task 4: Implement Empty States (AC: 4, 5, IV3)
- [x] Create empty state for new users
  - [x] Message: "Create your first program to get started"
  - [x] CTA: "Create Program" â†’ Navigate to program builder
  - [x] Secondary CTA: "Browse Programs"
- [x] Create empty state for existing users
  - [x] Message: "Your programs from mobile will appear here"
  - [x] Subtext: "Open the mobile app to create or sync programs"
  - [x] CTA: "Download Mobile App"

### Task 5: Calculate Next Workout Info (AC: 2)
- [x] Implement next workout logic in `lib/utils/program-utils.ts`
  - [x] Find next scheduled workout based on current day
  - [x] Format: "Pull Day - Tomorrow (Thu)"
  - [x] Handle edge cases: No workouts, no schedule
  - [x] Export utility functions for reuse

### Task 6: Integrate Analytics (AC: 6)
- [x] Add "Dashboard Card Viewed" on mount via DashboardCard
  - [x] Properties: `cardType: 'active_program'`, `hasData: boolean`, `hasActiveProgram: boolean`
- [x] Analytics integrated through DashboardCard wrapper

### Task 7: Testing
- [x] Write unit tests for program utilities
  - [x] Test: findActiveRoutine function
  - [x] Test: formatWorkoutDetails function
  - [x] Test: formatRoutineLastUpdated function
- [x] Write unit tests for useRoutines hook
  - [x] Test: Successful data fetching
  - [x] Test: Error handling
  - [x] Test: Loading states
- [x] Write integration tests for card
  - [x] Test: Card displays program info
  - [x] Test: View button navigates correctly
  - [x] Test: Edit button checks user state
  - [x] Test: Read-only message shows for existing users
  - [x] Test: Empty states differ by user type
  - [x] Test: Analytics events fire

## Dev Notes

### ðŸ”§ Developer Setup Reference
**Development Prerequisites**: Complete Stories 1.1-1.4
- **Setup Guide**: `docs/DEVELOPER_SETUP.md`
- **Dependencies**: React Query (installed in Story 1.1)
- **Branch**: `feature/story-1.8-active-program-card`

**Source**: [DEVELOPER_SETUP.md]

### ðŸ“ User Flow & Wireframe References
**User Flow**: Active Program Card shows current training plan and next workout
- **Flow Reference**: `docs/web-app-user-flows.md` - Section "Existing User Journey Step 2" (Dashboard Card 5)
- **Wireframe**: `docs/wireframes.md` - Section 2.1 (Dashboard - Populated State, Card 5: Active Program)

**Key UX Requirements**:
- Full-width card (spans both columns)
- Shows program name, week progress, next workout
- Edit access gated by user data state (MVP constraint)
- Empty states vary by user type (new vs existing)

**Source**: [web-app-user-flows.md - Card 5: Active Program Summary, wireframes.md - Section 2.1]

### ðŸŽ¨ Wireframe for Implementation

#### Active Program Card (Full-Width Below Dashboard Grid)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Active Program: Push/Pull/Legs - Week 5 of 12                       â”‚
â”‚  Next workout: Pull Day - Tomorrow (Thu)                             â”‚
â”‚  [View Program]  [Edit Program]  [Start Workout on Mobile]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Card Dimensions**:
- Width: 100% of dashboard width (1376px on desktop)
- Height: 120px
- Padding: 24px
- Full-width: Spans both columns (md:col-span-2)

**Content Layout**:
- Line 1: "Active Program: {Program Name} - Week {X} of {Y}" (18px, bold)
- Line 2: "Next workout: {Workout Name} - {Day}" (16px, regular, gray)
- Line 3: Action buttons (horizontal row, 12px gap)

**Buttons**:
- "View Program": Secondary button (gray border)
- "Edit Program": Primary button (blue) - Gated by user state
- "Start Workout on Mobile": Tertiary button (text link)

**Empty State (New Users)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                       â”‚
â”‚  ðŸ“‹ Create your first program to get started                         â”‚
â”‚                                                                       â”‚
â”‚  [Create Program]  [Browse Recommended Programs]                     â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Empty State (Existing Users)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                       â”‚
â”‚  ðŸ“± Your programs from mobile will appear here                       â”‚
â”‚     Open the mobile app to create or sync programs                  â”‚
â”‚                                                                       â”‚
â”‚  [Download Mobile App]                                               â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Source**: [wireframes.md - Section 2.1, Card: Active Program]

### API Integration
**Routines Endpoint**:
```
GET /api/routine
Response: { 
  routines: Routine[] 
}

interface Routine {
  id: string;
  userId: string;
  title: string;
  description?: string;
  isDefault?: boolean;
  lastUsedAt?: string;
  workouts: Workout[];
}

interface Workout {
  id: string;
  title: string;
  dayOfWeek?: number;  // 0-6 (Sunday-Saturday)
  exercises: WorkoutExercise[];
}
```

**Active Program Logic**:
1. Fetch all routines
2. Find program with `isDefault: true`
3. If no default, use program with most recent `lastUsedAt`
4. If no programs, show appropriate empty state

**Source**: [API Integration (MVP) - Routine (Program) Endpoints, Data Architecture]

### User State Gating (Critical MVP Constraint)
**Edit Access Control**:
```typescript
// components/dashboard/ActiveProgramCard.tsx
import { useUserDataState } from '@/hooks/useUserDataState';

export function ActiveProgramCard({ program }: { program: Routine }) {
  const { data: userState } = useUserDataState();
  const router = useRouter();
  
  const handleEditClick = () => {
    // Check user data state
    if (userState?.state === 'new') {
      // New user: Allow edit
      router.push(`/app/programs/${program.id}/edit`);
      
      analytics.track('Dashboard Card Clicked', {
        action: 'edit_program',
        allowed: true,
        programId: program.id
      });
    } else {
      // Existing user or unknown: Block edit
      showReadOnlyDialog();
      
      analytics.track('Dashboard Card Clicked', {
        action: 'edit_program_blocked',
        allowed: false,
        userState: userState?.state
      });
    }
  };
  
  return (
    <Card className="md:col-span-2">
      <CardContent className="p-6">
        <h3 className="text-lg font-bold">
          Active Program: {program.title} - Week {currentWeek} of {totalWeeks}
        </h3>
        <p className="text-gray-600">
          Next workout: {nextWorkout.title} - {nextWorkout.day}
        </p>
        <div className="mt-4 flex gap-3">
          <Button onClick={() => router.push(`/app/programs/${program.id}`)}>
            View Program
          </Button>
          <Button 
            onClick={handleEditClick}
            variant={userState?.state === 'new' ? 'default' : 'outline'}
          >
            Edit Program
          </Button>
          <Button variant="link">
            Start Workout on Mobile
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Source**: [MVP Overview - Critical MVP Constraint, Component Architecture - Program Builder Components]

### Next Workout Calculation
```typescript
// lib/utils/program-utils.ts
export function getNextWorkout(program: Routine): {
  workout: Workout;
  day: string;
} | null {
  const today = new Date().getDay();  // 0-6
  
  // Find next workout based on schedule
  const scheduledWorkouts = program.workouts
    .filter(w => w.dayOfWeek !== undefined)
    .sort((a, b) => a.dayOfWeek! - b.dayOfWeek!);
  
  // Find next upcoming workout
  const nextWorkout = scheduledWorkouts.find(w => w.dayOfWeek! > today)
    || scheduledWorkouts[0];  // Wrap to next week
  
  if (!nextWorkout) return null;
  
  const daysUntil = nextWorkout.dayOfWeek! > today
    ? nextWorkout.dayOfWeek! - today
    : 7 - today + nextWorkout.dayOfWeek!;
  
  const dayLabel = daysUntil === 0 ? 'Today'
    : daysUntil === 1 ? 'Tomorrow'
    : format(addDays(new Date(), daysUntil), 'EEE');  // "Thu"
  
  return {
    workout: nextWorkout,
    day: `${dayLabel} (${format(addDays(new Date(), daysUntil), 'MMM d')})`
  };
}
```

**Source**: [Component Architecture - Program Components, Data Architecture]

### Read-Only Dialog Component
**For Existing Users** (can't edit programs):
```typescript
// components/programs/ReadOnlyProgramDialog.tsx
export function ReadOnlyProgramDialog({ isOpen, onClose }: DialogProps) {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Program editing on mobile only</DialogTitle>
          <DialogDescription>
            Editing programs on web is coming soon! For now, use the mobile app 
            to edit your routines.
          </DialogDescription>
        </DialogHeader>
        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            View Program Details
          </Button>
          <Button onClick={() => window.location.href = getMobileAppLink()}>
            Download App
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Source**: [Component Architecture - Program Builder Components, ProgramBuilderGate pattern]

### Testing Requirements

**Unit Tests** (Jest):
- Active program selection logic
- Next workout calculation
- User state gating logic

**Integration Tests** (Testing Library + MSW):
- Card renders with program data
- View button navigation
- Edit button state-based behavior
- Read-only dialog shows for existing users
- Empty states differ by user type
- Analytics events fire

**Test File Locations**:
- `__tests__/lib/utils/program-utils.test.ts`
- `__tests__/components/dashboard/ActiveProgramCard.test.tsx`

**Source**: [Testing Strategy - Unit Tests, Integration Tests]

## Testing

### Test Coverage Requirements
- Unit test coverage: > 85% for program logic
- Integration test coverage: All states and user interactions

### Test Scenarios
1. **Active Program (New User)**: Shows program, edit button enabled
2. **Active Program (Existing User)**: Shows program, edit button shows dialog
3. **No Program (New User)**: Empty state with "Create Program" CTA
4. **No Program (Existing User)**: Empty state with "Download App" message
5. **View Program**: Click view â†’ Navigate to program detail
6. **Edit (New User)**: Click edit â†’ Navigate to editor
7. **Edit (Existing User)**: Click edit â†’ Show read-only dialog
8. **Next Workout**: Calculate correctly based on schedule and current day

### Performance Targets
- Card render: < 100ms
- Program fetch: < 200ms
- Smooth interactions: 60fps

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation with complete references | Bob (SM) |
| 2025-10-29 | 1.1 | Implementation completed - Active Program Card now functional with full test coverage | James (Dev) |
| 2025-10-29 | 1.2 | CRITICAL BUG FIX #1: Fixed API response parsing (array vs object) and field name (defaultRoutine vs isDefault) | James (Dev) |
| 2025-10-29 | 1.3 | CRITICAL BUG FIX #2: Fixed active routine detection to use workout logs (training history) instead of defaultRoutine field | James (Dev) |
| 2025-10-30 | 1.4 | CRITICAL BUG FIX #3: Fixed workout logs parsing - now handles both response formats. Verified working with user's actual data. | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor IDE)

### Debug Log References
- All tests passing: 31/31 tests pass
- Test suites: `__tests__/lib/utils/program-utils.test.ts`, `__tests__/hooks/useRoutines.test.ts`, `__tests__/components/dashboard/ActiveProgramCard.test.tsx`

### Completion Notes List
1. **Root Cause Found**: Previous developer created placeholder skeleton (`ProgramCardSkeleton`) but never implemented the actual `ActiveProgramCard` component
2. **Architecture Fix**: Component now properly uses existing `DashboardCard` wrapper for consistency
3. **Design System Compliance**: All components follow established patterns from `design-system.md`:
   - Uses `DashboardCard` wrapper with proper analytics integration
   - Leverages shadcn/ui components (Button, Card, etc.)
   - Follows established loading/error/empty state patterns
4. **Type Safety**: Created `types/routine.ts` with proper TypeScript interfaces for `Routine` and `Workout`
5. **React Query Integration**: Implemented `hooks/useRoutines.ts` using existing `/api/workout` proxy endpoint
6. **Utility Functions**: Created reusable program utilities in `lib/utils/program-utils.ts`
7. **User State Gating**: Properly integrated with `useUserDataState` hook for edit access control
8. **Full Width Support**: Extended `DashboardCard` with `fullWidth` prop for proper grid spanning
9. **Comprehensive Testing**: 31 tests covering utilities, hooks, and component integration
10. **Empty States**: Implemented differentiated empty states for new vs existing users
11. **CRITICAL BUG FIX #1** (discovered during user testing):
    - **Issue**: API returns array directly, not wrapped in `{ data: Routine[] }` object
    - **Issue**: Backend uses `defaultRoutine` field, not `isDefault`
    - **Fix**: Updated `hooks/useRoutines.ts` to handle array response correctly
    - **Fix**: Updated types and all references from `isDefault` to `defaultRoutine`
12. **CRITICAL BUG FIX #2** (discovered during user testing):
    - **Issue**: "defaultRoutine" is just a starter routine, NOT the active routine
    - **Issue**: Previous implementation showed default routine instead of the one user is actively training
    - **Root Cause**: Active routine must be determined by workout logs (training history), not a field
    - **Fix**: Created `hooks/useWorkoutLogs.ts` to fetch training history from `/api/workout-log`
    - **Fix**: Updated `lib/utils/program-utils.ts` to find active routine by matching recent workout titles
    - **Fix**: Updated `findActiveRoutine()` to accept workout sessions and find which routine contains the last trained workout
    - **Fix**: Updated `getNextWorkout()` to determine next workout based on training history pattern
    - **Impact**: Card now displays the ACTUAL active routine based on what user is training, and correctly suggests next workout in sequence
13. **CRITICAL BUG FIX #3** (discovered during user testing):
    - **Issue**: `useWorkoutLogs` was returning 0 sessions even though user had 12 workout logs
    - **Root Cause**: API response format was `{ sessions: [...] }` but hook was only checking for array
    - **Fix**: Updated `hooks/useWorkoutLogs.ts` to handle BOTH response formats (array OR object with sessions property)
    - **Verification**: User confirmed the card now correctly displays their active routine based on training history
    - **Status**: âœ… WORKING - Verified with user's actual account data

### File List

**New Files Created:**
- `types/routine.ts` - TypeScript interfaces for Routine and Workout
- `hooks/useRoutines.ts` - React Query hook for fetching routines
- `hooks/useWorkoutLogs.ts` - React Query hook for fetching workout logs (training history)
- `lib/utils/program-utils.ts` - Utility functions for routine logic (active routine detection, next workout calculation)
- `components/dashboard/ActiveProgramCard.tsx` - Main Active Program Card component
- `__tests__/lib/utils/program-utils.test.ts` - Unit tests for utilities
- `__tests__/hooks/useRoutines.test.ts` - Unit tests for routines hook
- `__tests__/components/dashboard/ActiveProgramCard.test.tsx` - Integration tests for component

**Modified Files:**
- `app/app/page.tsx` - Replaced `ProgramCardSkeleton` with `ActiveProgramCard`
- `components/dashboard/DashboardCard.tsx` - Added `fullWidth` prop for grid spanning

## QA Results
*(To be populated by QA agent after dev completion)*



