# Story 1.10: CSV Import Flow

## Status
Draft

## Story
**As a** user with prior training history,  
**I want** to import my workouts from Hevy or Strong,  
**so that** I have complete historical data in EzLift.

## Acceptance Criteria
1. Upload CSV file (Hevy or Strong format)
2. Parse CSV client-side (PapaParse library)
3. Fuzzy match exercise names with exercise library (MiniSearch, 0.2 fuzzy threshold)
4. Show import summary:
   - X workouts found, Y exercises, Z total sets
   - N unmapped exercises (with names listed)
   - User can review and confirm
5. On confirm: Batch create sessions via `POST /workout-log` (one-by-one - backend doesn't support bulk)
6. Progress bar: "Importing X of Y workouts"
7. Handle errors gracefully (continue with remaining workouts if one fails)
8. Success screen: Summary with CTAs "View Dashboard" or "View History"
9. Imported sessions flagged: `isImported: true`, `importedAt: timestamp`
10. Analytics: Full import funnel (uploaded, parsed, confirmed, progress, completed/failed)

## Integration Verification
- IV1: Hevy CSV format parsed correctly (test with sample file)
- IV2: Exercise fuzzy matching >90% success rate
- IV3: Batch import handles failures gracefully
- IV4: Dashboard automatically refreshes after import (React Query invalidation)

## Tasks / Subtasks

### Task 1: Create Import Page and Flow Shell (AC: 1)
- [ ] Create `app/app/import/page.tsx`
  - [ ] Import flow container with multi-step wizard
  - [ ] State machine for flow steps: upload â†’ parsing â†’ review â†’ importing â†’ success/error
- [ ] Create `components/import/ImportFlow.tsx`
  - [ ] Multi-step wizard component
  - [ ] Progress indicator (Step X of 5)
  - [ ] Step components: Upload, Processing, Review, Progress, Success

### Task 2: Implement CSV Upload Component (AC: 1)
- [ ] Create `components/import/CsvUploader.tsx`
  - [ ] File input (accept=".csv")
  - [ ] Drag-and-drop zone
  - [ ] File validation (file type, size < 10MB)
  - [ ] Show selected filename
  - [ ] "Upload" button to proceed

### Task 3: Implement CSV Parsing Logic (AC: 2, IV1)
- [ ] Create `lib/import/csv-parser.ts`
  - [ ] Install and configure PapaParse
  - [ ] Parse Hevy CSV format (confirmed structure)
  - [ ] Extract: title, start_time, end_time, exercise_title, set data
  - [ ] Group rows by workout (title + start_time + end_time)
  - [ ] Group exercises within workout
  - [ ] Create WorkoutSession objects
  - [ ] Handle malformed CSV gracefully

### Task 4: Implement Exercise Fuzzy Matching (AC: 3, IV2)
- [ ] Create `lib/import/exercise-matcher.ts`
  - [ ] Initialize MiniSearch with exercise library
  - [ ] Configure fuzzy threshold: 0.2
  - [ ] Match Hevy exercise names to EzLift exercises
  - [ ] Return matched exerciseId or null
  - [ ] Track unmapped exercises for review
  - [ ] Test matching accuracy (target: >90%)

### Task 5: Create Import Summary Component (AC: 4)
- [ ] Create `components/import/ImportSummary.tsx`
  - [ ] Display: X workouts found, Y unique exercises, Z total sets
  - [ ] List unmapped exercises (if any)
  - [ ] Show sample workout for verification
  - [ ] "Confirm Import" button
  - [ ] "Cancel" button (returns to upload)

### Task 6: Implement Batch Import Logic (AC: 5, 6, 7, IV3)
- [ ] Create `lib/import/batch-importer.ts`
  - [ ] Import sessions one-by-one or in small batches
  - [ ] POST /api/logs for each session
  - [ ] Update progress state after each session
  - [ ] Handle individual failures (log error, continue with next)
  - [ ] Track: successful, failed counts
  - [ ] Flag imported sessions: `isImported: true`, `importedAt: timestamp`

### Task 7: Create Import Progress Component (AC: 6)
- [ ] Create `components/import/ImportProgress.tsx`
  - [ ] Progress bar: "Importing X of Y workouts"
  - [ ] Percentage: "45%"
  - [ ] Current workout being imported
  - [ ] Estimated time remaining
  - [ ] Cancel button (abort remaining imports)

### Task 8: Create Success Screen (AC: 8, IV4)
- [ ] Create `components/import/ImportSuccess.tsx`
  - [ ] Success message with celebration icon ğŸ‰
  - [ ] Summary stats: Workouts imported, exercises, sets
  - [ ] If failures: Show count and error summary
  - [ ] CTAs: "View Dashboard" and "View History"
  - [ ] Invalidate React Query cache on success
  - [ ] Test dashboard refresh (shows imported data)

### Task 9: Integrate Analytics Funnel (AC: 10)
- [ ] Add analytics events for complete funnel
  - [ ] "Import Started" (source: 'hevy')
  - [ ] "Import File Uploaded" (fileSize: number)
  - [ ] "Import Parsed" (workouts: number, unmapped: number)
  - [ ] "Import Confirmed" (workouts: number)
  - [ ] "Import Progress" (current: number, total: number) - every 10%
  - [ ] "Import Completed" (successful: number, failed: number, duration: number)
  - [ ] "Import Failed" (error: string, stage: string)

### Task 10: Error Handling (AC: 7, IV3)
- [ ] Implement error handling for each stage
  - [ ] File upload errors: Invalid format, too large
  - [ ] Parse errors: Malformed CSV, missing columns
  - [ ] Matching errors: No exercises matched
  - [ ] Import errors: API failures, network issues
  - [ ] Show user-friendly error messages
  - [ ] Provide retry or skip options
  - [ ] Log errors for debugging

### Task 11: Testing
- [ ] Create test CSV files
  - [ ] Valid Hevy CSV (10 workouts)
  - [ ] Malformed CSV (missing columns)
  - [ ] Large CSV (500+ workouts)
- [ ] Write unit tests for parser
  - [ ] Test: Parse valid Hevy CSV
  - [ ] Test: Group by workout correctly
  - [ ] Test: Handle malformed CSV
  - [ ] Test: Extract sets correctly
- [ ] Write unit tests for exercise matcher
  - [ ] Test: Exact match (100% accuracy)
  - [ ] Test: Fuzzy match (typo handling)
  - [ ] Test: No match (unmapped exercises)
  - [ ] Test: Match accuracy >90%
- [ ] Write integration tests for flow
  - [ ] Test: Complete import flow end-to-end
  - [ ] Test: Upload â†’ Parse â†’ Review â†’ Import â†’ Success
  - [ ] Test: Handle errors at each stage
  - [ ] Test: Progress updates correctly
  - [ ] Test: Dashboard refreshes after import
  - [ ] Test: Analytics events fire correctly

## Dev Notes

### ğŸ”§ Developer Setup Reference
**Development Prerequisites**: Complete Stories 1.1-1.9
- **Setup Guide**: `docs/DEVELOPER_SETUP.md`
- **New Dependencies**: `npm install papaparse minisearch`
- **Branch**: `feature/story-1.10-csv-import-flow`

**Source**: [DEVELOPER_SETUP.md]

### ğŸ“ User Flow & Wireframe References
**User Flow**: CSV Import enables users to bring training history from other apps
- **Flow Reference**: `docs/web-app-user-flows.md` - Section "Import Flow" (Separate from Program Setup)
- **Wireframe**: `docs/wireframes.md` - Section 4 (Import Flow screens 4.1-4.3)

**Key UX Requirements**:
- Multi-step wizard (5 screens)
- Clear progress indication
- Review before importing (no surprises)
- Handle unmapped exercises gracefully
- Optional (can be done later or never)

**Important**: Import is for **history/stats only**, not programs

**Source**: [web-app-user-flows.md - Import Flow, wireframes.md - Section 4]

### ğŸ¨ Wireframes for Implementation

#### Screen 1: Import Landing / Selection
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Import Your Workout History                                           [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                        Bring your data from another app                     â”‚
â”‚                     Your stats and history will be populated                â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“¤ Import from Hevy                                                 â”‚   â”‚
â”‚  â”‚  Export from Hevy app: Settings â†’ Backup â†’ Export CSV               â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  [ğŸ“ Choose Hevy CSV File]                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“¤ Import from Strong (Coming Soon)                                 â”‚   â”‚
â”‚  â”‚  Export from Strong app: Settings â†’ Export â†’ CSV                    â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  [ğŸ“ Choose Strong CSV File] (Disabled)                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  ğŸ’¡ What gets imported:                                                     â”‚
â”‚  â€¢ All your past workouts                                                   â”‚
â”‚  â€¢ Exercise history and personal records                                    â”‚
â”‚  â€¢ Training volume and progress data                                        â”‚
â”‚                                                                              â”‚
â”‚  â„¹ï¸ Note: This imports workout history only. You'll still need to          â”‚
â”‚     create or select a program for future tracking.                         â”‚
â”‚                                                                              â”‚
â”‚  [Cancel]                                            [Import Data â†’]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Screen 2: Processing
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Import Your Workout History                                           [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                         Processing your workout history...                  â”‚
â”‚                                                                              â”‚
â”‚                           â³ (Animated spinner)                              â”‚
â”‚                         â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  45%                          â”‚
â”‚                                                                              â”‚
â”‚                      â€¢ Parsing CSV file                     âœ…              â”‚
â”‚                      â€¢ Matching exercises                   â³              â”‚
â”‚                      â€¢ Preparing workouts                   â—‹               â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚                      This usually takes 10-30 seconds                       â”‚
â”‚                      Depending on your data size                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Screen 3: Review & Confirm
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Import Your Workout History                                           [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                         Review Your Import                                  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“Š Import Summary                                                     â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  âœ… 127 workouts found                                                â”‚ â”‚
â”‚  â”‚  âœ… 23 unique exercises                                               â”‚ â”‚
â”‚  â”‚  âœ… 2,341 total sets                                                  â”‚ â”‚
â”‚  â”‚  âœ… Date range: Jan 2023 - Jan 2025                                   â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  âš ï¸  3 exercises couldn't be matched:                                       â”‚
â”‚                                                                              â”‚
â”‚  â€¢ "Bench Pres" â†’ Did you mean "Barbell Bench Press"? [Yes] [Skip]         â”‚
â”‚  â€¢ "Leg Curl Machine" â†’ Did you mean "Leg Curl"? [Yes] [Skip]              â”‚
â”‚  â€¢ "Custom Exercise ABC" â†’ No match found [Import as custom] [Skip]        â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  [â† Back to Upload]                              [Confirm Import â†’]         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Screen 4: Importing (Progress)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Importing Your Workouts...                                            [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚                         â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘  65%                          â”‚
â”‚                                                                              â”‚
â”‚                        Importing workout 83 of 127                          â”‚
â”‚                           "Pull Day - Week 12"                              â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚                      âœ… 82 workouts imported successfully                   â”‚
â”‚                      â³ 45 remaining                                         â”‚
â”‚                      â±ï¸  Estimated time: 2 minutes                          â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚                           [Cancel Import]                                   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Screen 5: Success
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Import Complete! ğŸ‰                                                   [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚                      Your workout history has been imported                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“Š Import Summary                                                     â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  âœ… 127 workouts imported                                             â”‚ â”‚
â”‚  â”‚  âœ… 23 exercises tracked                                              â”‚ â”‚
â”‚  â”‚  âœ… 2,341 sets recorded                                               â”‚ â”‚
â”‚  â”‚  â±ï¸  Import completed in 3m 42s                                       â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚              [View Dashboard]         [View History]                         â”‚
â”‚                                                                              â”‚
â”‚                       [Import More Data]                                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Design Specs**:

**Import Modal/Page** (Max-width: 800px, centered):
- Background: White
- Padding: 32px
- Border-radius: 12px
- Shadow: Large (0 8px 24px rgba(0,0,0,0.15))

**File Upload Zone**:
- Border: 2px dashed gray (#d1d5db)
- Height: 200px
- Hover: Blue dashed border (#2563eb)
- Drag active: Blue background (#eff6ff)
- Icon: Upload cloud icon, 48px
- Text: 16px, gray

**Progress Bars**:
- Height: 12px
- Background: Light gray (#e5e7eb)
- Fill: Blue gradient (#2563eb to #3b82f6)
- Border-radius: 6px
- Animation: Smooth fill transition

**Summary Cards**:
- Background: Light blue (#eff6ff)
- Padding: 24px
- Border: 1px solid blue (#2563eb)
- Stats: Large numbers (24px), labels (14px gray)

**Unmapped Exercises**:
- Alert box: Yellow background (#fef3c7)
- Border: Yellow (#f59e0b)
- List: Bullet points, 14px
- Suggestions: Inline "Did you mean?" with Yes/No buttons

**Source**: [wireframes.md - Section 4.1-4.3]

### Hevy CSV Format
**Confirmed Structure**:
```csv
title,start_time,end_time,description,exercise_title,superset_id,
exercise_notes,set_index,set_type,weight_kg,reps,distance_km,
duration_seconds,rpe
```

**Example**:
```csv
"Full Body B","18 Dec 2024, 21:13","18 Dec 2024, 21:58","","Leg Press (Machine)",,"",0,"normal",250,15,,,
"Full Body B","18 Dec 2024, 21:13","18 Dec 2024, 21:58","","Leg Press (Machine)",,"",1,"normal",250,14,,,
```

**Key Fields**:
- `title`: Workout/program name
- `start_time`, `end_time`: Workout duration
- `exercise_title`: Exercise name (may have typos or variations)
- `set_index`: Set number (0-based)
- `weight_kg`: Weight in kg
- `reps`: Rep count

**Source**: [Import Flow Architecture - CSV Import Process, Hevy CSV Structure]

### Parsing Implementation
**PapaParse Configuration**:
```typescript
// lib/import/csv-parser.ts
import Papa from 'papaparse';

export function parseHevyCsv(csvText: string): ParseResult {
  const { data, errors } = Papa.parse<HevyRow>(csvText, {
    header: true,
    skipEmptyLines: true,
    transform: (value) => value.trim(),
    dynamicTyping: true  // Auto-convert numbers
  });
  
  if (errors.length > 0) {
    throw new Error(`CSV parsing failed: ${errors[0].message}`);
  }
  
  return processHevyRows(data);
}

function processHevyRows(rows: HevyRow[]): ParseResult {
  // Group by workout (title + start_time + end_time)
  const workouts = groupByWorkout(rows);
  
  // Convert to WorkoutSession objects
  const sessions = workouts.map(workout => ({
    id: generateUUID(),
    workoutTitle: workout.title,
    sessionDate: parseHevyDate(workout.start_time),
    duration: calculateDuration(workout.start_time, workout.end_time),
    isImported: true,
    importedAt: new Date().toISOString(),
    logs: groupExercises(workout.rows)
  }));
  
  return { sessions, unmappedCount: 0 };
}
```

**Source**: [Import Flow Architecture - Import Implementation]

### Exercise Fuzzy Matching
**MiniSearch Configuration**:
```typescript
// lib/import/exercise-matcher.ts
import MiniSearch from 'minisearch';

// Initialize with exercise library
const miniSearch = new MiniSearch({
  fields: ['name', 'aliases'],  // Search in name and aliases
  storeFields: ['id', 'name', 'primaryMuscleGroup', 'exerciseType'],
  searchOptions: {
    fuzzy: 0.2,  // Allow typos (20% edit distance)
    prefix: true,  // Match prefixes
    boost: { name: 2, aliases: 1 }  // Prioritize exact name matches
  }
});

// Load exercise library
const exercises = await fetchExerciseLibrary();
miniSearch.addAll(exercises);

// Match exercise
export function matchExercise(hevyName: string): Exercise | null {
  const results = miniSearch.search(hevyName, { fuzzy: 0.2 });
  
  if (results.length === 0) return null;
  
  // Return best match (highest score)
  return results[0] as Exercise;
}

// Batch matching with suggestions
export function matchExercises(hevyNames: string[]): MatchResult[] {
  return hevyNames.map(name => {
    const match = matchExercise(name);
    
    return {
      originalName: name,
      matched: match !== null,
      suggestedExercise: match,
      confidence: match ? calculateConfidence(name, match.name) : 0
    };
  });
}
```

**Expected Matching Accuracy**: >90% for common exercises

**Source**: [Import Flow Architecture - Fuzzy Match Exercises, Technology Stack - Search & Fuzzy Matching]

### Batch Import Strategy
**Sequential Import with Progress**:
```typescript
// lib/import/batch-importer.ts
export async function importSessions(
  sessions: WorkoutSession[],
  onProgress: (current: number, total: number) => void
): Promise<ImportResult> {
  const results = {
    successful: 0,
    failed: 0,
    errors: [] as string[]
  };
  
  for (let i = 0; i < sessions.length; i++) {
    try {
      await createSession(sessions[i]);
      results.successful++;
    } catch (error) {
      results.failed++;
      results.errors.push(`Workout ${i + 1}: ${error.message}`);
      console.error(`Failed to import session ${i}:`, error);
    }
    
    // Update progress every workout
    onProgress(i + 1, sessions.length);
    
    // Fire analytics every 10%
    if ((i + 1) % Math.ceil(sessions.length / 10) === 0) {
      analytics.track('Import Progress', {
        current: i + 1,
        total: sessions.length,
        percentage: Math.round(((i + 1) / sessions.length) * 100)
      });
    }
  }
  
  // Invalidate React Query cache
  queryClient.invalidateQueries({ queryKey: ['sessions'] });
  queryClient.invalidateQueries({ queryKey: ['stats'] });
  
  return results;
}
```

**Error Handling**: Continue importing remaining workouts if one fails

**Source**: [Import Flow Architecture - Bulk Create Sessions]

### State Machine for Import Flow
**Flow States**:
```typescript
type ImportState = 
  | { step: 'upload'; file: null }
  | { step: 'parsing'; file: File; progress: number }
  | { step: 'review'; parsed: ParsedImport }
  | { step: 'importing'; sessions: WorkoutSession[]; progress: number }
  | { step: 'success'; result: ImportResult }
  | { step: 'error'; error: string };

// State transitions
upload â†’ parsing â†’ review â†’ importing â†’ success/error
```

**Source**: [Import Flow Architecture - Import Flow UX]

### Testing Requirements

**Test Data**:
- Create sample Hevy CSV files for testing
- Valid CSV: 10 workouts, standard exercises
- Large CSV: 500+ workouts (performance test)
- Malformed CSV: Missing columns, invalid dates

**Unit Tests** (Jest):
- CSV parsing (valid and invalid)
- Exercise matching (exact, fuzzy, no match)
- Workout grouping logic
- Date parsing (Hevy format)
- Duration calculation

**Integration Tests** (Testing Library + MSW):
- Complete import flow
- Upload â†’ Parse â†’ Review â†’ Import â†’ Success
- Error handling at each stage
- Progress updates
- Dashboard refresh after import

**Test File Locations**:
- `__tests__/lib/import/csv-parser.test.ts`
- `__tests__/lib/import/exercise-matcher.test.ts`
- `__tests__/lib/import/batch-importer.test.ts`
- `__tests__/components/import/ImportFlow.test.tsx`

**Source**: [Testing Strategy - Unit Tests, Integration Tests]

### Performance Considerations
**Client-Side Parsing Benefits**:
- No server load for parsing
- Instant feedback (no upload delay)
- Works offline (parse locally)

**Performance Targets**:
- Parse CSV (100 workouts): < 1 second
- Exercise matching (100 unique exercises): < 500ms
- Import API calls (100 workouts): ~20-40 seconds (network dependent)

**Optimization**:
- Parse in Web Worker (non-blocking UI)
- Batch API calls (if backend supports)
- Show progress to manage user expectations

**Source**: [Import Flow Architecture - CSV Import Process, Performance Strategy]

### Analytics Funnel Events
**Complete Import Funnel**:
```typescript
// Event 1: Import started
analytics.track('Import Started', { source: 'hevy' });

// Event 2: File uploaded
analytics.track('Import File Uploaded', { 
  fileSize: file.size,
  fileName: file.name 
});

// Event 3: Parsing complete
analytics.track('Import Parsed', {
  workouts: parsed.totalWorkouts,
  exercises: parsed.uniqueExercises.length,
  sets: parsed.totalSets,
  unmapped: parsed.unmappedExercises.length,
  parseDuration: parseTime
});

// Event 4: User confirmed
analytics.track('Import Confirmed', {
  workouts: sessions.length
});

// Event 5: Progress updates (every 10%)
analytics.track('Import Progress', {
  current: 50,
  total: 127,
  percentage: 39
});

// Event 6: Import complete
analytics.track('Import Completed', {
  successful: 125,
  failed: 2,
  duration: importDuration
});

// Event 7: Import failed (if error)
analytics.track('Import Failed', {
  error: error.message,
  stage: 'parsing' | 'matching' | 'importing'
});
```

**Source**: [Analytics Integration - Event Taxonomy, Event Tracking Strategy]

## Testing

### Test Coverage Requirements
- Unit test coverage: > 90% for parsing and matching logic
- Integration test coverage: Complete import flow end-to-end

### Test Scenarios
1. **Valid Hevy CSV**: Upload â†’ Parse â†’ Review â†’ Import â†’ Success
2. **Unmapped Exercises**: Some exercises don't match â†’ User reviews â†’ Confirms â†’ Imports
3. **Malformed CSV**: Invalid file â†’ Error message shown
4. **Large Import**: 500 workouts â†’ Progress bar updates â†’ Completes
5. **Partial Failure**: Some workouts fail â†’ Import continues â†’ Shows success + error summary
6. **Cancel Import**: Start import â†’ Click cancel â†’ Import stops, partial data saved
7. **Dashboard Refresh**: After import â†’ Dashboard shows imported data
8. **Analytics Funnel**: All events fire at correct stages

### Performance Targets
- CSV parse (100 workouts): < 1 second
- Exercise matching: < 500ms
- Total import time (100 workouts): 20-40 seconds (network dependent)
- UI remains responsive during import

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation with complete references | Bob (SM) |

## Dev Agent Record
*(To be populated by dev agent during implementation)*

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

### ğŸ”´ CRITICAL: API Endpoint Correction
**URGENT: Backend API uses `/workout-log` endpoint, not `/api/logs`**

- **Problem**: Stories were originally documented with incorrect `/api/logs` endpoint
- **Solution**: All API routes and implementations MUST use `/workout-log` endpoint
- **Impact**: Stories 1.2, 1.4, 1.5, 1.6, 1.7, 1.9, 1.10 need to be redone to use correct endpoint
- **Files to Update**:
  - `app/api/workout-log/route.ts` (create/rename from logs)
  - All fetch calls must use `/workout-log` instead of `/api/logs`
  - Update tests to mock correct endpoint

## QA Results
*(To be populated by QA agent after dev completion)*



