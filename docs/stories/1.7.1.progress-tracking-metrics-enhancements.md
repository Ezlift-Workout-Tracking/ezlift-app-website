# Story 1.7.1: Progress Tracking â€” Additional Metrics & Legend Toggles

## Status
Draft

## Story
As a user,
I want to view multiple progress metrics for a selected exercise and toggle them on/off,
so that I can understand my strength trends from different perspectives (estimated 1RM, true max weight, and total weight volume).

## Acceptance Criteria
1. Metrics supported (per selected exercise, within selected date range):
   - Est. 1RM (Epley): `weight Ã— (1 + reps/30)` â€” weekly maximum (best set in the week)
   - Max weight: highest single-set weight â€” weekly maximum
   - Total weight (volume): `Î£(weight Ã— reps)` across all sets â€” weekly sum
2. Legend-as-toggles (no dropdown): Inline pill/checkbox chips with colored dots to show/hide series.
   - Default ON: Est. 1RM; Default OFF: Max weight, Total weight
   - Persist last selection per user (localStorage) for convenience
   - Keyboard accessible (tab/focus, space/enter toggles)
3. Color + pattern coding (color-blind friendly):
   - Est. 1RM: Blue `#2563eb`, solid line
   - Max weight: Orange `#f97316`, dashed line
   - Total weight: Purple `#7c3aed`, dotted line or light area fill
4. Axes behavior:
   - Left Y-axis: Weight (kg/lb) for Est. 1RM and Max weight
   - Right Y-axis: Total weight (kg/lb). Right axis only appears when Total weight is ON
   - Axis labels include unit (kg/lb)
5. Tooltip improvements:
   - Unified tooltip shows date and active metrics values with color keys
   - Each legend chip has a hover/click info tooltip explaining metric and formula
   - Copy example for Est. 1RM: "Estimated 1 Rep Max using Epley formula: weight Ã— (1 + reps/30). Uses your best set each week."
6. Footer stats area updates:
   - Always shows the primary metricâ€™s stats (Starting, Current, Progress)
   - Primary = first active metric by priority [Est. 1RM, Max, Total] (user doesnâ€™t pick a primary)
7. Data aggregation granularity:
   - Aggregate per week (across all sessions of that ISO/userâ€‘locale week for the exercise)
   - Use `startOfWeek(date, { weekStartsOn: userPref })` to bucket
   - If multiple sessions exist in a week, apply weekly rules in AC1
8. Empty/Loading/Error states mirror Story 1.7 patterns
9. Analytics:
   - "Dashboard Card Viewed" (cardType: 'progress') includes `metricsOn: string[]`
   - "Dashboard Card Interaction" on toggle with `action: 'metric_toggled'`, `metric: 'est1rm|max|total'`, `enabled: boolean`
10. Performance: Rendering remains smooth with 200+ points; computations memoized; no blocking on main thread

## UX Design Notes

### Layout Additions
- Place a compact "Metrics" row above the chart (right of selectors on wide screens; stacked on mobile):
  - [â€¢ Est. 1RM] [â€¢ Max weight] [â€¢ Total weight] â€” pill toggles with color dot and checkmark
  - Add an "i" icon next to "Metrics" label â†’ small popover with formulas and examples

### Formulas & Definitions (legend tooltips)
- Est. 1RM: `weight Ã— (1 + reps/30)`; max per day (best set). Example: 60kg Ã— 5 â†’ 70kg
- Max weight: Highest single-set weight performed that day for the exercise.
- Total weight: Sum of `weight Ã— reps` across all sets of the exercise that day (aka training volume for that exercise).

### Accessibility & Visual Encoding
- Do not rely solely on color: use line styles (solid/dashed/dotted) and area fill for Total weight
- Ensure 3:1 contrast for lines vs background; focus-visible rings on chips; ARIA labels for tooltips

### Units & Axes
- Respect user unit preference (kg/lb). Axis labels indicate unit explicitly.
- When Total weight is enabled, show a right Y-axis labeled "Total weight (kg/lb)". Hide it otherwise.

### Interactions
- Hover a legend chip â†’ show metric formula tooltip; click toggles visibility
- Hover a point â†’ tooltip lists active metrics with values and units
- Clicking a point retains the existing behavior (future: opens workout detail)

## Data Specification
Aggregate by week per exercise within the current date range.
- For each week W:
  - Est. 1RM(W) = max over all sets in W of `Epley(weight, reps)` (best set of the week)
  - Max weight(W) = max over all sets in W of `weight`
  - Total weight(W) = sum over all sets in W of `weight Ã— reps`
- Exclusions & fallbacks:
  - Missing weight or reps: exclude that set from Total weight; exclude weightless sets from Max weight; Est. 1RM requires both weight and reps
  - Bodyweight-only sets: if bodyweight is known, treat as that weight; otherwise exclude from these three metrics

## Wireframe (delta)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Progress Tracking                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ [ Exercise â–¾ ]                    Metrics: [â— Est. 1RM âœ“]   â”‚
â”‚ [ Range â–¾ ]                               [â— Max weight]    â”‚
â”‚                                           [â— Total weight]  â”‚
â”‚                                                             â”‚
â”‚                  ðŸ“ˆ Multiâ€‘series LineChart                  â”‚
â”‚        (Left Y: kg/lb for 1RM & Max | Right Y: Total)       â”‚
â”‚                                                             â”‚
â”‚ Starting â€¦      Current â€¦      Progress â€¦ (primary metric)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Analytics Schema
```ts
// On card mount
analytics.track('Dashboard Card Viewed', {
  cardType: 'progress',
  hasData: boolean,
  metricsOn: string[], // ['est1rm'] or ['est1rm','max'] etc.
});

// On metric toggle
analytics.track('Dashboard Card Interaction', {
  action: 'metric_toggled',
  cardType: 'progress',
  metric: 'est1rm' | 'max' | 'total',
  enabled: boolean,
});
```

## Technical Notes (Implementation Guidance)
- Add utilities in `lib/stats/progress.ts`:
  - `aggregateExerciseWeekSeries(sessions, exerciseId, unitPref, weekStartsOn)` â†’ base week grouping
  - Build three weekly series from grouped sets; memoize results
- Component delta in `components/dashboard/ProgressChartCard.tsx`:
  - Add chips row (shadcn/ui `Toggle` or custom pill checkboxes)
  - Add a second `YAxis` for Total when that series is ON
  - Tooltip renders only active series; legend chips control visibility
  - Persist selected metrics in `localStorage['progress.metrics']`
- Performance: keep data within selected range (4w/12w/6m/1y); pre-aggregate once per change

### Dev Checklist (Weekly Aggregation + Legend Toggles + Tooltips)
- Data & Utils
  - [ ] Implement `aggregateExerciseWeekSeries()` with date-fns `startOfWeek` bucketing (respect user week start).
  - [ ] Compute per-week: Est. 1RM = max(Epley) across all sets; Max weight = max(weight); Total = sum(weightÃ—reps).
  - [ ] Respect unit preference (kg/lb) in outputs and axis labels.
  - [ ] Memoize by inputs: sessions hash + exerciseId + range + weekStartsOn + unit.

- Component UI (`components/dashboard/ProgressChartCard.tsx`)
  - [ ] Add "Metrics" chips row: Est. 1RM (default ON), Max weight (OFF), Total weight (OFF).
  - [ ] Colors/styles: Est. 1RM blue solid; Max orange dashed; Total purple dotted or area.
  - [ ] Dual Y-axes: Left for weight metrics; Right only when Total ON.
  - [ ] Persist chip state in `localStorage['progress.metrics']` and hydrate on mount.
  - [ ] Keyboard/focus: chips tabbable; space/enter toggles; ARIA pressed state.

- Tooltip & Legend Explainers
  - [ ] Unified chart tooltip listing active metrics with colored keys and units.
  - [ ] Legend chip hover/click tooltip with formula text:
        â€¢ Est. 1RM: Epley, best set in week.
        â€¢ Max weight: Highest single-set weight in week.
        â€¢ Total weight: Sum(weightÃ—reps) across week.
  - [ ] Add small "i" info popover near "Metrics" label with the same explanations and examples.

- Footer Stats
  - [ ] Determine primary metric by priority [Est. 1RM â†’ Max â†’ Total].
  - [ ] Compute Starting (first week), Current (last week), Progress (Î” and % where applicable).
  - [ ] If primary is Total, show Î” volume; if zero baseline, omit %.

- Analytics
  - [ ] On mount: track `Dashboard Card Viewed` with `metricsOn`.
  - [ ] On chip toggle: track `metric_toggled` with `metric` and `enabled`.

- Performance
  - [ ] Pre-aggregate on data/selection change; avoid per-render loops.
  - [ ] Keep render smooth with 200+ points; consider down-sampling for 1y.

- Edge Cases
  - [ ] Weeks with missing data â†’ gaps or zero per metric (choose consistent rule; recommended: gaps for Est.1RM/Max, zero for Total).
  - [ ] Sets missing weight/reps excluded from relevant metrics; document in tooltip.
  - [ ] Multiple sessions in a week handled correctly.

- Testing
  - [ ] Unit: Epley boundary cases; weekly grouping; tie handling for max; total sum correctness; unit conversion.
  - [ ] Integration: chip toggles update chart/axes; tooltip values/formulas; localStorage persistence; analytics fired.

- Accessibility & Polish
  - [ ] Visible focus rings; chips announce pressed state; tooltips labelled.
  - [ ] Color contrast â‰¥ 3:1; pattern/line-style differentiation.
  - [ ] Motion-respect for transitions.

## Testing
Unit Tests
- Est. 1RM examples and boundaries (reps 1, 5, 10, >30)
- Perâ€‘week aggregation with multiple sessions (multiple days & sessions)
- Max weight selection logic with ties
- Total weight summation; missing weights ignored

Integration Tests
- Chips toggle visibility; chart updates; axes appear/disappear correctly
- Tooltip shows correct values and formulas
- Footer stats map to primary metric as specified
- localStorage persists user selection

## Out of Scope
- Additional metrics (e.g., intensity, tonnage per session normalized by BW)
- Detailed workout modal (covered by separate story)

## Change Log
| Date       | Version | Description                                     | Author |
|------------|---------|-------------------------------------------------|--------|
| 2025-10-13 | 0.1     | Initial story draft for multiâ€‘metric progress  | Sally  |
