# Story 1.11: Program Builder (New Users Only)

## Status
Draft

## Story
**As a** new user,  
**I want** to create workout programs using a visual builder,  
**so that** I can plan my training routines on a large screen.

## Acceptance Criteria
1. **Access Control**: Only accessible if user data state = "new"
2. **Existing users**: Show read-only message with CTAs "View Programs" or "Download Mobile App"
3. **Builder Features**:
   - 4-column exercise grid (reuses ExerciseCard from public site)
   - Debounced search (reuses DebouncedSearchInput, 250ms desktop, 350ms mobile)
   - Muscle group filters (reuses ExerciseFilters)
   - Click exercise â†’ Add to current workout
   - Configure sets per exercise (reps, weight, rest time)
   - Drag-and-drop reordering
   - Real-time metrics panel (muscles covered, estimated duration, exercise variety)
4. **Flow Navigation**: Workout 1 â†’ Workout 2 â†’ Workout 3 â†’ Overview â†’ Save
5. **Save**: `POST /api/routine` â†’ `POST /api/workout` Ã— N
6. **Backend writes to Changes table** (confirmed working via migration)
7. **Success**: Redirect to dashboard with program card populated
8. **Analytics**: Full funnel (opened, exercise added, program saved, time to complete)

## Integration Verification
- IV1: User data state check prevents existing users from accessing
- IV2: Programs created on web appear on mobile after first sync
- IV3: Exercise search/filter performance matches public library
- IV4: Drag-and-drop works on desktop, touch reorder on mobile

## Tasks / Subtasks

### Task 1: Implement Access Control Gate (AC: 1, 2, IV1)
- [ ] Create `components/programs/ProgramBuilderGate.tsx`
  - [ ] Check user data state using `useUserDataState()` hook
  - [ ] If state === 'new': Render children (full builder access)
  - [ ] If state === 'existing' or 'unknown': Show read-only message
  - [ ] While loading: Show skeleton
- [ ] Create read-only message component
  - [ ] Heading: "Program Builder - New Users Only"
  - [ ] Message: Explain MVP constraint and mobile app editing
  - [ ] List what existing users CAN do
  - [ ] CTAs: "View Programs" and "Download Mobile App"

### Task 2: Create Program Builder Page Structure (AC: 3, 4)
- [ ] Create `app/app/programs/create/page.tsx`
  - [ ] Wrap with ProgramBuilderGate
  - [ ] Initialize program builder state machine
  - [ ] Steps: workout1 â†’ workout2 â†’ workout3 â†’ overview â†’ saving â†’ success
- [ ] Create `components/programs/ProgramBuilderShell.tsx`
  - [ ] Left sidebar: Workout navigation + metrics panel
  - [ ] Main content: Current workout editor + exercise grid
  - [ ] Header: Program name input, Save Draft, Close buttons

### Task 3: Create Workout Editor Component (AC: 3)
- [ ] Create `components/programs/WorkoutEditor.tsx`
  - [ ] Workout name input (editable)
  - [ ] Exercise list (added exercises)
  - [ ] For each exercise:
    - Drag handle for reordering
    - Exercise name (clickable â†’ detail modal)
    - Sets configuration (inline edit)
    - Delete button
  - [ ] "+ Add Another Exercise" button
  - [ ] "Workout Complete - Next Workout â†’" CTA (bottom)

### Task 4: Integrate Exercise Selection Grid (AC: 3, IV3)
- [ ] Reuse existing components from public site:
  - [ ] `components/exercise/ExerciseCard.tsx` - Exercise display
  - [ ] `components/exercise/DebouncedSearchInput.tsx` - Search
  - [ ] `components/exercise/ExerciseFilters.tsx` - Muscle group filters
- [ ] Modify ExerciseCard for builder context:
  - [ ] Replace "View Details" button with "+ Add" button
  - [ ] Add click handler to add exercise to current workout
  - [ ] Show "âœ“ Added" state temporarily (2 sec)
- [ ] Test search/filter performance (should match public library)

### Task 5: Implement Set Configuration Modal (AC: 3)
- [ ] Create `components/programs/SetConfigurator.tsx`
  - [ ] Input: Number of sets (default: 3)
  - [ ] Input: Reps or rep range (default: 8-12)
  - [ ] Input: Weight (optional, kg or lbs)
  - [ ] Input: Rest time between sets (default: 90 seconds)
  - [ ] "Add to Workout" button
  - [ ] Opens when user clicks "+ Add" on exercise card

### Task 6: Implement Drag-and-Drop Reordering (AC: 3, IV4)
- [ ] Install and configure drag-and-drop library (dnd-kit or react-beautiful-dnd)
  - [ ] Enable drag handle on desktop
  - [ ] Implement touch reordering for mobile
  - [ ] Visual feedback during drag (ghost element)
  - [ ] Update exercise order in state on drop
  - [ ] Smooth animation (no layout shift)

### Task 7: Create Real-Time Metrics Panel (AC: 3)
- [ ] Create `components/programs/MetricsPanel.tsx` (left sidebar)
  - [ ] Muscles Covered: List of muscle groups from added exercises
  - [ ] Estimated Duration: Calculate based on sets Ã— rest time
  - [ ] Exercise Variety: Count push/pull, upper/lower
  - [ ] Update in real-time as exercises added/removed
  - [ ] Display in sidebar (always visible)

### Task 8: Implement Multi-Workout Flow (AC: 4)
- [ ] Create workout navigation in sidebar
  - [ ] Workout 1, 2, 3 buttons (clickable)
  - [ ] Current workout highlighted (blue circle filled)
  - [ ] Completed workouts: Green checkmark
  - [ ] "+ Add Workout" button (max 6 workouts)
- [ ] Implement flow navigation
  - [ ] "Next Workout â†’" button at bottom of each workout
  - [ ] Auto-saves current workout before transitioning
  - [ ] Shows "Overview" after last workout
- [ ] Create program overview screen
  - [ ] Show all workouts in program
  - [ ] Edit any workout (navigate back)
  - [ ] "Save Program" final CTA

### Task 9: Implement Save Logic (AC: 5, 6)
- [ ] Create `lib/mutations/create-program.ts`
  - [ ] POST /api/routine (create program)
  - [ ] For each workout: POST /api/workout (create workout template)
  - [ ] Link workouts to routine
  - [ ] Set first program as default (isDefault: true)
  - [ ] Verify Changes table write (from architecture docs)
- [ ] Add optimistic update
  - [ ] Show loading state during save
  - [ ] Handle errors (show error, allow retry)
  - [ ] On success: Redirect to dashboard

### Task 10: Implement Success Redirect (AC: 7, IV2)
- [ ] After save success:
  - [ ] Invalidate React Query cache: `['routines']`, `['user', 'data-state']`
  - [ ] Show success toast: "Program created successfully!"
  - [ ] Redirect to dashboard
  - [ ] Verify dashboard Active Program card shows new program
- [ ] Test sync to mobile app
  - [ ] Verify Changes table write (mobile syncs this)
  - [ ] Document testing steps for mobile sync verification

### Task 11: Integrate Analytics Funnel (AC: 8)
- [ ] Add analytics events for complete funnel
  - [ ] "Program Builder Opened" (userState: 'new')
  - [ ] "Program Builder Exercise Added" (exerciseId, workoutNum)
  - [ ] "Program Builder Workout Completed" (workoutNum, exerciseCount, duration)
  - [ ] "Program Builder Navigation" (from: workout, to: workout)
  - [ ] "Program Builder Saved" (workoutCount, totalExercises, timeToComplete: seconds)
  - [ ] "Program Builder Abandoned" (currentWorkout, exercisesAdded)

### Task 12: Create Read-Only Message for Existing Users (AC: 2)
- [ ] Create blocked state component
  - [ ] Heading: "Program Builder - New Users Only"
  - [ ] Explanation: MVP constraint, mobile app editing
  - [ ] List what existing users CAN do:
    - View existing programs
    - Use mobile app to create/edit
    - Import workout history
    - View analytics
  - [ ] CTAs: "View Programs" and "Download Mobile App"

### Task 13: Testing
- [ ] Write unit tests for access control
  - [ ] Test: New user state â†’ Builder accessible
  - [ ] Test: Existing user state â†’ Blocked message
  - [ ] Test: Unknown state â†’ Blocked (fail-safe)
- [ ] Write unit tests for metrics calculations
  - [ ] Test: Muscle coverage calculation
  - [ ] Test: Duration estimation
  - [ ] Test: Exercise variety counting
- [ ] Write integration tests for builder flow
  - [ ] Test: Add exercise to workout
  - [ ] Test: Configure sets for exercise
  - [ ] Test: Reorder exercises (drag-and-drop)
  - [ ] Test: Complete workout â†’ Navigate to next
  - [ ] Test: Complete all workouts â†’ Overview screen
  - [ ] Test: Save program â†’ Creates routine and workouts
  - [ ] Test: Redirect to dashboard after save
  - [ ] Test: Dashboard shows new program
  - [ ] Test: Analytics events fire correctly
- [ ] Write E2E test for complete flow
  - [ ] Test: Open builder â†’ Add exercises â†’ Create 3 workouts â†’ Save â†’ Verify dashboard

## Dev Notes

### ğŸ”§ Developer Setup Reference
**Development Prerequisites**: Complete Stories 1.1-1.8 (especially 1.2 for user state)
- **Setup Guide**: `docs/DEVELOPER_SETUP.md`
- **New Dependencies**: `npm install @dnd-kit/core @dnd-kit/sortable` (drag-and-drop)
- **Branch**: `feature/story-1.11-program-builder`

**Source**: [DEVELOPER_SETUP.md]

### ğŸ“ User Flow & Wireframe References
**User Flow**: Program Builder is only for new users (critical MVP constraint)
- **Flow Reference**: `docs/web-app-user-flows.md` - Section "Onboarding Step 7" and "Decision Point 2"
- **Wireframe**: `docs/wireframes.md` - Section 1.10 (Program Builder - Complete flow with wireframes)

**Critical MVP Constraint**:
- **New users** (no data): Full program builder access
- **Existing users** (has mobile data): View only, must edit on mobile
- **Why**: Prevents sync conflicts with WatermelonDB (mobile app)
- **Removed in Phase 2**: WatermelonDB on web enables full editing

**User Flow Paths**:
- New user onboarding â†’ "No, I need a program" â†’ Program recommendations
- New user onboarding â†’ "Yes, I have a program" â†’ Describe program OR "Use Program Builder instead" link â†’ **This story**
- From dashboard â†’ "Create Program" CTA â†’ **This story** (if new user)

**Source**: [web-app-user-flows.md - User Data State & Flow Branching, Onboarding Step 7, wireframes.md - Section 1.10]

### ğŸ¨ Wireframes for Implementation

#### Program Builder - Initial State (Workout 1, No Exercises)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Logo]  Dashboard  Programs  History  Import              [Avatar â–¾]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Program Builder: Workout 1                              [Save Draft] [Ã—]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ SIDE   â”‚  â”‚  Program: [Untitled Program___________]  âœ                  â”‚   â”‚
â”‚ PANEL  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ“‹ â”‚ â”‚  â”‚  ğŸ‹ï¸ Workout 1                            [Rename] [â‹®]        â”‚   â”‚
â”‚ â”‚ W1 â”‚ â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚ â”‚[â—] â”‚ â”‚  â”‚  Exercises in this workout: 0                               â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”˜ â”‚  â”‚  ğŸ’¡ Tip: Start by adding your first exercise               â”‚   â”‚
â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â” â”‚                                                                      â”‚
â”‚ â”‚ ğŸ“‹ â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ W2 â”‚ â”‚  â”‚  ğŸ” Search exercises...                        [Show Filters]â”‚   â”‚
â”‚ â”‚[â—‹] â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â””â”€â”€â”€â”€â”˜ â”‚                                                                      â”‚
â”‚        â”‚  Popular Exercises for Getting Started:                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ ğŸ“‹ â”‚ â”‚  â”‚  [Image]  â”‚ â”‚  [Image]  â”‚ â”‚  [Image]  â”‚ â”‚  [Image]  â”‚          â”‚
â”‚ â”‚ W3 â”‚ â”‚  â”‚  Barbell  â”‚ â”‚  Barbell  â”‚ â”‚  Dumbbell â”‚ â”‚  Lateral  â”‚          â”‚
â”‚ â”‚[â—‹] â”‚ â”‚  â”‚  Bench    â”‚ â”‚  Squat    â”‚ â”‚  Row      â”‚ â”‚  Raises   â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”˜ â”‚  â”‚  Press    â”‚ â”‚           â”‚ â”‚           â”‚ â”‚           â”‚          â”‚
â”‚        â”‚  â”‚  [Chest]  â”‚ â”‚  [Legs]   â”‚ â”‚  [Back]   â”‚ â”‚  [Should] â”‚          â”‚
â”‚ â”€â”€â”€â”€â”€  â”‚  â”‚  Push     â”‚ â”‚  Lower    â”‚ â”‚  Pull     â”‚ â”‚  Push     â”‚          â”‚
â”‚        â”‚  â”‚  [+Add]   â”‚ â”‚  [+Add]   â”‚ â”‚  [+Add]   â”‚ â”‚  [+Add]   â”‚          â”‚
â”‚ [+Add  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚ Workoutâ”‚                                                                      â”‚
â”‚ ]      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚        â”‚  â”‚  [Image]  â”‚ â”‚  [Image]  â”‚ â”‚  [Image]  â”‚ â”‚  [Image]  â”‚          â”‚
â”‚ â”€â”€â”€â”€â”€  â”‚  â”‚  Deadlift â”‚ â”‚  Pull-ups â”‚ â”‚  Overhead â”‚ â”‚  Leg      â”‚          â”‚
â”‚        â”‚  â”‚           â”‚ â”‚           â”‚ â”‚  Press    â”‚ â”‚  Press    â”‚          â”‚
â”‚Metrics â”‚  â”‚  [Back]   â”‚ â”‚  [Back]   â”‚ â”‚  [Should] â”‚ â”‚  [Legs]   â”‚          â”‚
â”‚        â”‚  â”‚  Pull     â”‚ â”‚  Pull     â”‚ â”‚  Push     â”‚ â”‚  Lower    â”‚          â”‚
â”‚ğŸ“Š Musc â”‚  â”‚  [+Add]   â”‚ â”‚  [+Add]   â”‚ â”‚  [+Add]   â”‚ â”‚  [+Add]   â”‚          â”‚
â”‚ Coveredâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                                                                      â”‚
â”‚ None   â”‚                    [Show More Exercises â†’]                          â”‚
â”‚        â”‚                                                                      â”‚
â”‚â± Duratâ”‚                                                                      â”‚
â”‚ion     â”‚                                                                      â”‚
â”‚        â”‚                                                                      â”‚
â”‚0 min   â”‚                                                                      â”‚
â”‚        â”‚                                                                      â”‚
â”‚ğŸ¯ Exercâ”‚                                                                      â”‚
â”‚ Varietyâ”‚                                                                      â”‚
â”‚        â”‚                                                                      â”‚
â”‚0 Push  â”‚                                                                      â”‚
â”‚0 Pull  â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Program Builder - With Exercises Added
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Program Builder: Workout 1                              [Save Draft] [Ã—]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SIDE   â”‚  Program: [Push/Pull/Legs_______________]  âœ                        â”‚
â”‚ PANEL  â”‚                                                                      â”‚
â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ [W1â—]  â”‚  â”‚  ğŸ‹ï¸ Workout 1: Push Day              [Done] [â‹®]              â”‚   â”‚
â”‚ [W2â—‹]  â”‚  â”‚  Exercises: 4  â€¢  Est. Duration: 45 min  â€¢  24 sets total   â”‚   â”‚
â”‚ [W3â—‹]  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚                                                                      â”‚
â”‚ [+Add  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ Workoutâ”‚  â”‚  Exercises in Workout 1:                    [Collapse â–²]    â”‚   â”‚
â”‚ ]      â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚   â”‚
â”‚        â”‚  â”‚                                                             â”‚   â”‚
â”‚Metrics â”‚  â”‚  1. ğŸ’ª Barbell Bench Press           [â†•] [Ã—] [â‹®]            â”‚   â”‚
â”‚        â”‚  â”‚     â€¢ 4 sets Ã— 8-10 reps @ 80 kg                            â”‚   â”‚
â”‚ğŸ“Š Musc â”‚  â”‚     â€¢ Chest, Shoulders, Triceps                             â”‚   â”‚
â”‚ Coveredâ”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚        â”‚  â”‚                                                             â”‚   â”‚
â”‚ Chest  â”‚  â”‚  2. ğŸ’ª Incline Dumbbell Press        [â†•] [Ã—] [â‹®]            â”‚   â”‚
â”‚ Should â”‚  â”‚     â€¢ 3 sets Ã— 10-12 reps @ 30 kg per hand                  â”‚   â”‚
â”‚ Tricep â”‚  â”‚     â€¢ Chest, Shoulders                                      â”‚   â”‚
â”‚        â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚â± Duratâ”‚  â”‚                                                             â”‚   â”‚
â”‚ion     â”‚  â”‚  3. ğŸ’ª Overhead Press                 [â†•] [Ã—] [â‹®]            â”‚   â”‚
â”‚        â”‚  â”‚     â€¢ 3 sets Ã— 8-12 reps @ 50 kg                            â”‚   â”‚
â”‚45 min  â”‚  â”‚     â€¢ Shoulders, Triceps                                    â”‚   â”‚
â”‚        â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â”‚
â”‚ğŸ¯ Exercâ”‚  â”‚                                                             â”‚   â”‚
â”‚ Varietyâ”‚  â”‚  4. ğŸ’ª Tricep Pushdowns               [â†•] [Ã—] [â‹®]            â”‚   â”‚
â”‚        â”‚  â”‚     â€¢ 3 sets Ã— 12-15 reps @ 40 kg                           â”‚   â”‚
â”‚4 Push  â”‚  â”‚     â€¢ Triceps                                               â”‚   â”‚
â”‚0 Pull  â”‚  â”‚                                                             â”‚   â”‚
â”‚        â”‚  â”‚  [+ Add Another Exercise]                                   â”‚   â”‚
â”‚4 Upper â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚0 Lower â”‚                                                                      â”‚
â”‚        â”‚  ğŸ” Search: [bench_____________]  [Filters: Chest â–¾]                â”‚
â”‚        â”‚                                                                      â”‚
â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚        â”‚  â”‚  [Results from search...]                             â”‚          â”‚
â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                                                                      â”‚
â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚        â”‚  â”‚           [Workout 1 Complete - Next Workout â†’]             â”‚   â”‚
â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Program Builder - Blocked State (Existing Users)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Logo]  Dashboard  Programs  History  Import              [Avatar â–¾]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âš ï¸ Program Builder - New Users Only                                 â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  The Program Builder is currently available only to new users.       â”‚   â”‚
â”‚  â”‚  Since you have existing workout data from the mobile app, program   â”‚   â”‚
â”‚  â”‚  editing is restricted to prevent sync conflicts.                    â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  **What you can do now:**                                            â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  âœ… View your existing programs (created on mobile app)              â”‚   â”‚
â”‚  â”‚  âœ… Use the mobile app to create or edit programs                    â”‚   â”‚
â”‚  â”‚  âœ… Import workout history from Hevy or Strong                       â”‚   â”‚
â”‚  â”‚  âœ… View analytics and progress on your dashboard                    â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  **Coming in Phase 2:** Full web editing with WatermelonDB sync      â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [View All Programs â†’]   â”‚  â”‚  [Download Mobile App]               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  [â† Back to Dashboard]                                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Design Specs**:

**Builder Layout**:
- Left sidebar: 200px width, fixed position
- Main content: Remaining width (1240px on desktop)
- Gap: 24px

**Sidebar Components**:
- Workout navigation: Vertical list, 48px per item
- Current workout: Blue circle filled (â—)
- Complete workout: Green checkmark (âœ“)
- Pending workout: Gray circle empty (â—‹)
- "+ Add Workout" button: Full-width, gray border
- Metrics panel: Below workout nav, real-time updates

**Main Content**:
- Program name: Large input, 24px, bold, editable inline
- Current workout card: Collapsible, shows exercise count and stats
- Exercise list: Added exercises with drag handles
- Exercise grid: 4 columns Ã— 280px cards (reuses ExerciseCard component)
- Search bar: Full-width, debounced (250ms desktop)

**Exercise Card in Builder**:
- Same design as public exercise library
- Replace "View Details" with "+ Add" button
- Click "+ Add" â†’ Opens set configuration modal OR adds with defaults
- After adding: Shows "âœ“ Added" (green, 2 sec)

**Set Configuration**:
- Opens in modal or inline panel
- Fields: Sets (number), Reps (range: "8-10"), Weight (optional), Rest time
- Defaults: 3 sets, 8-12 reps, 90s rest
- Save adds exercise to workout list

**Source**: [wireframes.md - Section 1.10, Complete Program Builder wireframes]

### Component Reuse Strategy
**Reuse from Public Site** (Story 1.11 AC 3):
1. `components/exercise/ExerciseCard.tsx` - Exercise display (modify "+ Add" button)
2. `components/exercise/DebouncedSearchInput.tsx` - Search (250ms desktop, 350ms mobile)
3. `components/exercise/ExerciseFilters.tsx` - Muscle group filters
4. `lib/services/exercise-data.ts` - Exercise library data access

**New Components to Create**:
1. `components/programs/ProgramBuilderShell.tsx` - Main layout
2. `components/programs/WorkoutEditor.tsx` - Workout exercise list
3. `components/programs/SetConfigurator.tsx` - Set configuration modal
4. `components/programs/MetricsPanel.tsx` - Real-time metrics sidebar
5. `components/programs/ProgramOverview.tsx` - Final review screen
6. `components/programs/ProgramBuilderGate.tsx` - Access control wrapper

**Source**: [Component Architecture - Program Builder Components, Reused Components]

### User Data State Gating (Critical!)
**Access Control Implementation**:
```typescript
// app/app/programs/create/page.tsx
import { ProgramBuilderGate } from '@/components/programs/ProgramBuilderGate';
import { ProgramBuilder } from '@/components/programs/ProgramBuilder';

export default function ProgramBuilderPage() {
  return (
    <ProgramBuilderGate>
      <ProgramBuilder />  {/* Only renders for new users */}
    </ProgramBuilderGate>
  );
}

// components/programs/ProgramBuilderGate.tsx
import { useUserDataState } from '@/hooks/useUserDataState';
import { ReadOnlyProgramMessage } from './ReadOnlyProgramMessage';

export function ProgramBuilderGate({ children }: { children: React.ReactNode }) {
  const { data: userState, isLoading } = useUserDataState();
  
  if (isLoading) {
    return <ProgramBuilderSkeleton />;
  }
  
  // Existing user â†’ Block access
  if (userState?.state === 'existing') {
    analytics.track('Program Builder Access Blocked', {
      userState: 'existing',
      reason: 'has_mobile_data'
    });
    return <ReadOnlyProgramMessage />;
  }
  
  // Unknown state (error) â†’ Block access (safe default)
  if (userState?.state === 'unknown') {
    analytics.track('Program Builder Access Blocked', {
      userState: 'unknown',
      reason: 'detection_failed'
    });
    return <ReadOnlyProgramMessage />;
  }
  
  // New user â†’ Full access
  analytics.track('Program Builder Opened', {
    userState: 'new'
  });
  
  return <>{children}</>;
}
```

**Source**: [Component Architecture - Program Builder Components, ProgramBuilderGate pattern, MVP Overview - Critical MVP Constraint]

### Real-Time Metrics Calculation
```typescript
// lib/utils/program-metrics.ts
export interface ProgramMetrics {
  musclesCovered: string[];
  estimatedDuration: number;  // minutes
  exerciseVariety: {
    push: number;
    pull: number;
    upper: number;
    lower: number;
  };
  totalSets: number;
}

export function calculateWorkoutMetrics(
  exercises: WorkoutExercise[]
): ProgramMetrics {
  const muscles = new Set<string>();
  let totalSets = 0;
  let estimatedDuration = 0;
  const variety = { push: 0, pull: 0, upper: 0, lower: 0 };
  
  exercises.forEach(ex => {
    // Add muscles
    ex.muscleGroups?.forEach(m => muscles.add(m));
    
    // Count sets
    totalSets += ex.sets || 3;
    
    // Estimate duration (sets Ã— 30 sec + rest time)
    const setDuration = (ex.sets || 3) * 30;  // 30 sec per set
    const restDuration = (ex.sets || 3) * (ex.restTime || 90);
    estimatedDuration += (setDuration + restDuration) / 60;  // Convert to minutes
    
    // Exercise variety
    if (ex.forceType === 'push') variety.push++;
    if (ex.forceType === 'pull') variety.pull++;
    if (ex.muscleGroups?.some(m => ['chest', 'shoulders', 'triceps', 'biceps', 'back'].includes(m))) {
      variety.upper++;
    }
    if (ex.muscleGroups?.some(m => ['legs', 'glutes', 'calves'].includes(m))) {
      variety.lower++;
    }
  });
  
  return {
    musclesCovered: Array.from(muscles),
    estimatedDuration: Math.round(estimatedDuration),
    exerciseVariety: variety,
    totalSets
  };
}
```

**Source**: [Component Architecture - Program Builder Components, MetricsPanel]

### Drag-and-Drop Implementation
**Library**: @dnd-kit/core + @dnd-kit/sortable
```typescript
// components/programs/WorkoutEditor.tsx
import { DndContext, closestCenter } from '@dnd-kit/core';
import { arrayMove, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

export function WorkoutEditor({ exercises, onReorder }: Props) {
  const handleDragEnd = (event) => {
    const { active, over } = event;
    
    if (active.id !== over.id) {
      const oldIndex = exercises.findIndex(ex => ex.id === active.id);
      const newIndex = exercises.findIndex(ex => ex.id === over.id);
      
      const reordered = arrayMove(exercises, oldIndex, newIndex);
      onReorder(reordered);
      
      analytics.track('Program Builder Exercise Reordered', {
        exerciseId: active.id,
        oldPosition: oldIndex + 1,
        newPosition: newIndex + 1
      });
    }
  };
  
  return (
    <DndContext collisionDetection={closestCenter} onDragEnd={handleDragEnd}>
      <SortableContext items={exercises} strategy={verticalListSortingStrategy}>
        {exercises.map((exercise, index) => (
          <SortableExerciseItem key={exercise.id} exercise={exercise} index={index} />
        ))}
      </SortableContext>
    </DndContext>
  );
}

function SortableExerciseItem({ exercise, index }: Props) {
  const { attributes, listeners, setNodeRef, transform, transition } = useSortable({ 
    id: exercise.id 
  });
  
  const style = {
    transform: CSS.Transform.toString(transform),
    transition
  };
  
  return (
    <div ref={setNodeRef} style={style} className="flex items-center gap-3 p-3 bg-white border rounded-lg">
      {/* Drag handle (desktop only) */}
      <div {...attributes} {...listeners} className="cursor-grab hidden md:block">
        <GripVertical className="text-gray-400" />
      </div>
      
      {/* Exercise content */}
      <div className="flex-1">
        <p className="font-semibold">{index + 1}. {exercise.name}</p>
        <p className="text-sm text-gray-600">
          {exercise.sets} sets Ã— {exercise.reps} reps @ {exercise.weight} kg
        </p>
        <p className="text-xs text-gray-500">
          {exercise.muscleGroups.join(', ')}
        </p>
      </div>
      
      {/* Actions */}
      <button onClick={() => onDelete(exercise.id)}>Ã—</button>
      <MoreMenu exercise={exercise} />
    </div>
  );
}
```

**Mobile Touch Reordering**:
- Use same library but with touch sensors
- Visual feedback: Shadow and scale up during drag

**Source**: [Component Architecture - Program Builder Components, IV4]

### Save Program Implementation
**API Calls** (AC 5, 6):
```typescript
// lib/mutations/create-program.ts
import { useMutation } from '@tanstack/react-query';

export function useCreateProgram() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (program: ProgramDraft) => {
      // Step 1: Create routine
      const routine = await createRoutine({
        title: program.title,
        description: program.description,
        isDefault: true,  // First program is default
        createdOnWeb: true
      });
      
      // Step 2: Create workouts
      for (const workout of program.workouts) {
        await createWorkout({
          routineId: routine.id,
          title: workout.title,
          dayOfWeek: workout.dayOfWeek,
          exercises: workout.exercises.map(ex => ({
            exerciseId: ex.exerciseId,
            sets: ex.sets,
            reps: ex.reps,
            weight: ex.weight,
            restTime: ex.restTime,
            order: ex.order
          }))
        });
      }
      
      return routine;
    },
    
    onSuccess: (routine) => {
      // Invalidate cache to refresh data
      queryClient.invalidateQueries({ queryKey: ['routines'] });
      queryClient.invalidateQueries({ queryKey: ['user', 'data-state'] });
      
      analytics.track('Program Builder Saved', {
        programId: routine.id,
        workoutCount: program.workouts.length,
        totalExercises: program.workouts.reduce((sum, w) => sum + w.exercises.length, 0),
        timeToComplete: Date.now() - startTime  // Track how long builder took
      });
      
      toast.success('Program created successfully!');
      router.push('/app');  // Redirect to dashboard
    },
    
    onError: (error) => {
      toast.error('Failed to save program. Please try again.');
      analytics.track('Program Builder Save Failed', {
        error: error.message
      });
    }
  });
}
```

**Backend Changes Table Write** (Confirmed in migration):
- Backend writes to Changes table automatically
- Mobile app syncs these changes on next pull
- New users' programs appear on mobile after first sync

**Source**: [API Integration (MVP) - Routine Endpoints, Import Flow Architecture]

### Testing Requirements

**Component Tests**:
- Access control gate (new vs existing users)
- Exercise selection and addition
- Set configuration
- Drag-and-drop reordering
- Metrics calculation
- Save program flow

**Integration Tests**:
- Complete builder flow (add exercises â†’ create 3 workouts â†’ save)
- Existing user blocked (shows read-only message)
- Dashboard refresh after save

**E2E Test** (Recommended):
- Open builder â†’ Search exercise â†’ Add to workout â†’ Configure sets â†’ Complete workout 1 â†’ Add to workout 2 â†’ Save program â†’ Verify dashboard

**Test File Locations**:
- `__tests__/components/programs/ProgramBuilderGate.test.tsx`
- `__tests__/components/programs/WorkoutEditor.test.tsx`
- `__tests__/components/programs/MetricsPanel.test.tsx`
- `__tests__/lib/utils/program-metrics.test.ts`
- `__tests__/integration/program-builder-flow.test.tsx`

**Source**: [Testing Strategy - Unit Tests, Integration Tests, E2E Tests]

## Testing

### Test Coverage Requirements
- Unit test coverage: > 85% for metrics and logic
- Integration test coverage: Complete builder flow
- E2E test: Full flow for new user

### Test Scenarios
1. **Access Control (New User)**: State = 'new' â†’ Builder accessible
2. **Access Control (Existing User)**: State = 'existing' â†’ Blocked message
3. **Add Exercise**: Click "+ Add" â†’ Exercise added to workout
4. **Configure Sets**: Add exercise â†’ Configure 4 sets Ã— 8-10 reps â†’ Saved
5. **Reorder Exercises**: Drag exercise 3 to position 1 â†’ Order updates
6. **Metrics Update**: Add exercise â†’ Metrics panel updates (muscles, duration)
7. **Complete Workout**: Click "Next Workout" â†’ Transitions to Workout 2
8. **Save Program**: Complete 3 workouts â†’ Save â†’ Creates routine + workouts
9. **Dashboard Redirect**: After save â†’ Redirects to dashboard
10. **Dashboard Shows Program**: Active Program card populated with new program
11. **Search/Filter**: Same performance as public exercise library
12. **Analytics Funnel**: All events fire at correct stages

### Performance Targets
- Exercise grid load: < 300ms
- Search/filter: < 200ms (same as public library)
- Metrics calculation: < 50ms (real-time)
- Drag-and-drop: 60fps smooth animation
- Save program: < 2 seconds (3 workouts)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation with complete references | Bob (SM) |

## Dev Agent Record
*(To be populated by dev agent during implementation)*

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

## QA Results
*(To be populated by QA agent after dev completion)*



