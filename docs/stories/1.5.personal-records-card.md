# Story 1.5: Personal Records Card

## Status
Done

## Story
**As a** user,  
**I want** to see my top personal records,  
**so that** I can celebrate achievements and track strength gains.

## Acceptance Criteria
1. Fetch recent sessions: `GET /workout-log` (all sessions, client-side date filtering for last 30-90 days)
2. Client-side computation: Find max weight Ã— reps (volume) per exercise
3. Sort by volume descending
4. Display top 5 PRs: Exercise name, weight, reps, date ("2 days ago")
5. ğŸ”¥ Icon for very recent PRs (within 7 days)
6. Empty state: "Your personal records will appear here"
7. Analytics: "Dashboard Card Viewed" (cardType: 'prs', hasData: boolean)
  
Additional (2025â€‘10â€‘13):
8. If exercise name is not present in session logs, resolve via `GET /api/exercise/{id}` and cache names clientâ€‘side.

## Integration Verification
- IV1: PR calculation correct (verified against sample data)
- IV2: Renders quickly even with 100+ sessions (< 50ms computation)

## Tasks / Subtasks

### Task 1: Create PR Calculation Logic (AC: 1, 2, 3)
- [x] Create `lib/stats/personal-records.ts`
  - [x] Implement `calculatePersonalRecords(sessions)` function
  - [x] Extract all exercises from all sessions
  - [x] For each exercise, find max (weight Ã— reps) across all sets
  - [x] Include session date for the PR
  - [x] Return sorted array (highest volume first)
  - [x] Handle edge cases: bodyweight exercises, missing weights

### Task 2: Create Personal Records Card Component (AC: 4, 5)
- [x] Create `components/dashboard/PersonalRecordsCard.tsx`
  - [x] Use shared `DashboardCard` wrapper for consistent header/states
  - [x] Integrate `useDateRange()` for date filter
  - [x] Fetch sessions using React Query (shares cache with TrainingVolumeCard)
        using normalized fetcher: `useQuery({ queryKey: ['sessions','all'], queryFn: fetchAllSessionsNormalized })`
  - [x] Call PR calculation function with useMemo
  - [x] Display top 5 PRs in list format
  - [x] Show: Exercise name, weight, reps, relative date
  - [x] Add Flame icon (Lucide) for PRs within last 7 days
  - [x] Format relative dates: "Today", "Yesterday", "X days ago", "MMM d"

### Task 3: Implement Empty State (AC: 6)
- [x] Create empty state for no PRs
  - [x] Show when no sessions in date range
  - [x] Message: "Your personal records will appear here"
  - [x] Subtext: "Track your first workout to set your baseline!"
  - [x] Icon: Trophy icon (Lucide)
  - [x] No additional CTA (empty state is sufficient)

### Task 4: Integrate Analytics (AC: 7)
- [x] Add analytics event on mount
  - [x] Event now emitted by `DashboardCard` wrapper
  - [x] Properties passed via `analyticsProps` (`cardType: 'prs'`, `hasData`, `prCount`, `dateRange`)

### Task 5: Performance Optimization (IV2)
- [x] Test PR calculation performance
  - [x] Tested with 100 sessions (500 sets): < 50ms âœ…
  - [x] Single-pass algorithm with Map for O(1) lookups
  - [x] useMemo prevents unnecessary recalculations
  - [x] Performance target met

### Task 6: Testing
- [x] Write unit tests for PR calculation (27 tests)
  - [x] Test: Single exercise, single PR
  - [x] Test: Multiple exercises, find max for each
  - [x] Test: Same exercise, multiple sessions, find max
  - [x] Test: Bodyweight exercises (no weight)
  - [x] Test: Empty sessions
  - [x] Test: Sorting and top 5 selection
  - [x] Test: Recent PR detection (< 7 days)
  - [x] Test: formatRelativeDate() edge cases
  - [x] Test: formatWeight() utility
- [x] Write integration tests for card (20 tests)
  - [x] Test: Card renders with PRs
  - [x] Test: Empty state shows correctly
  - [x] Test: Recent PR gets ğŸ”¥ icon
  - [x] Test: Date filter integration
  - [x] Test: Analytics event fires
  - [x] Test: Loading and error states

## Dev Notes

### ğŸ”§ Developer Setup Reference
**Development Prerequisites**: Complete Stories 1.1-1.4
- **Setup Guide**: `docs/DEVELOPER_SETUP.md`
- **Branch**: `feature/story-1.5-personal-records-card`

**Source**: [DEVELOPER_SETUP.md]

### ğŸ“ User Flow & Wireframe References
**User Flow**: Personal Records Card shows recent strength achievements
- **Flow Reference**: `docs/web-app-user-flows.md` - Section "Existing User Journey Step 2" (Dashboard Card 2)
- **Wireframe**: `docs/wireframes.md` - Section 2.1 (Dashboard - Populated State, Card 2: Personal Records)

**Key UX Requirements**:
- Show top 5 PRs from selected date range
- Highlight very recent PRs (< 7 days) with ğŸ”¥ icon
- Relative dates for better context ("2 days ago")
- Empty state encourages first workout

**Source**: [web-app-user-flows.md - Card 2: Top PRs, wireframes.md - Section 2.1]

### ğŸ¨ Wireframe for Implementation

#### Personal Records Card (Top-Right Dashboard Card)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Personal Records          â”‚  â† Card heading (20px bold)
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  Last 30 days              â”‚  â† Date range (from global filter)
â”‚                            â”‚
â”‚  ğŸ”¥ Barbell Bench Press    â”‚  â† PR item (ğŸ”¥ if < 7 days)
â”‚     100 kg Ã— 5 reps        â”‚     Exercise name (16px, bold)
â”‚     2 days ago             â”‚     Weight Ã— reps
â”‚                            â”‚     Relative date (14px, gray)
â”‚  ğŸ’ª Barbell Squat          â”‚
â”‚     140 kg Ã— 8 reps        â”‚  â† PR item (no ğŸ”¥ if > 7 days)
â”‚     Yesterday              â”‚
â”‚                            â”‚
â”‚  ğŸ‹ï¸ Deadlift               â”‚
â”‚     180 kg Ã— 3 reps        â”‚
â”‚     3 days ago             â”‚
â”‚                            â”‚
â”‚  ğŸ’ª Overhead Press         â”‚
â”‚     70 kg Ã— 6 reps         â”‚
â”‚     5 days ago             â”‚
â”‚                            â”‚
â”‚  ğŸ”¥ Barbell Row            â”‚
â”‚     90 kg Ã— 8 reps         â”‚
â”‚     Yesterday              â”‚
â”‚                            â”‚
â”‚  [View All PRs â†’]          â”‚  â† CTA link (future)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Card Dimensions**:
- Width: 664px (desktop), 100% (mobile)
- Height: 340px
- Padding: 24px

**PR Item Design**:
- Icon: ğŸ”¥ (for recent < 7 days), ğŸ’ª or ğŸ‹ï¸ (for older)
- Exercise name: 16px, bold, dark gray
- Weight Ã— reps: 16px, regular, medium gray
- Date: 14px, light gray
- Spacing: 12px between items

**Empty State**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Personal Records          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                            â”‚
â”‚       ğŸ†                   â”‚  â† Trophy icon (large)
â”‚                            â”‚
â”‚  Your personal records     â”‚  â† Message (centered)
â”‚  will appear here          â”‚
â”‚                            â”‚
â”‚  Track your first workout  â”‚  â† Motivational text
â”‚  to set your baseline!     â”‚
â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Source**: [wireframes.md - Section 2.1, Card: Personal Records]

### PR Calculation Algorithm
**Definition**: Personal Record = Maximum (weight Ã— reps) for an exercise

```typescript
// lib/stats/personal-records.ts
import { formatDistanceToNow } from 'date-fns';

export interface PersonalRecord {
  exerciseId: string;
  exerciseName: string;
  weight: number;  // kg or lbs
  reps: number;
  volume: number;  // weight Ã— reps
  date: Date;
  sessionId: string;
  isRecent: boolean;  // within 7 days
}

export function calculatePersonalRecords(
  sessions: WorkoutSession[]
): PersonalRecord[] {
  const prMap = new Map<string, PersonalRecord>();
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  
  sessions.forEach(session => {
    session.logs?.forEach(log => {
      log.sets?.forEach(set => {
        const weight = set.weight || 0;
        const reps = set.reps || 0;
        const volume = weight * reps;
        
        // Skip bodyweight or incomplete sets
        if (weight === 0 || reps === 0) return;
        
        const existing = prMap.get(log.exerciseId);
        
        // If no PR exists or this is higher, update
        if (!existing || volume > existing.volume) {
          prMap.set(log.exerciseId, {
            exerciseId: log.exerciseId,
            exerciseName: log.exerciseName,
            weight,
            reps,
            volume,
            date: new Date(session.sessionDate),
            sessionId: session.id,
            isRecent: new Date(session.sessionDate) > sevenDaysAgo
          });
        }
      });
    });
  });
  
  // Sort by volume descending, return top 5
  return Array.from(prMap.values())
    .sort((a, b) => b.volume - a.volume)
    .slice(0, 5);
}

export function formatRelativeDate(date: Date): string {
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  
  // For older dates, show actual date
  return format(date, 'MMM d');
}
```

**Source**: [Data Architecture (MVP) - Data Aggregation Strategy]

### Component Implementation Pattern
```typescript
// components/dashboard/PersonalRecordsCard.tsx
import { useQuery } from '@tanstack/react-query';
import { useDateRange } from '@/hooks/useDateRange';
import { calculatePersonalRecords } from '@/lib/stats/personal-records';

export function PersonalRecordsCard() {
  const { startDate, endDate } = useDateRange();
  
  const { data: sessions, isLoading } = useQuery({
    queryKey: ['sessions', 'by-date', startDate, endDate],
    queryFn: () => fetchSessions({ startDate, endDate })
  });
  
  const prs = useMemo(() => 
    calculatePersonalRecords(sessions || []),
    [sessions]
  );
  
  useEffect(() => {
    analytics.track('Dashboard Card Viewed', {
      cardType: 'prs',
      hasData: prs.length > 0,
      prCount: prs.length
    });
  }, [prs.length]);
  
  return (
    <DashboardCard 
      title="Personal Records"
      isEmpty={prs.length === 0}
      emptyState={<EmptyPRsState />}
    >
      <p className="text-sm text-gray-600 mb-4">Last 30 days</p>
      
      <div className="space-y-3">
        {prs.map(pr => (
          <div key={pr.exerciseId} className="flex items-start gap-2">
            <span className="text-xl">{pr.isRecent ? 'ğŸ”¥' : 'ğŸ’ª'}</span>
            <div>
              <p className="font-semibold text-gray-900">{pr.exerciseName}</p>
              <p className="text-gray-600">
                {pr.weight} kg Ã— {pr.reps} reps
              </p>
              <p className="text-sm text-gray-500">
                {formatRelativeDate(pr.date)}
              </p>
            </div>
          </div>
        ))}
      </div>
      
      {prs.length > 0 && (
        <button className="mt-4 text-blue-600 text-sm font-medium">
          View All PRs â†’
        </button>
      )}
    </DashboardCard>
  );
}
```

**Source**: [Component Architecture - Dashboard Components, Dashboard Card Pattern]

### Performance Considerations
**Target Performance**:
- PR calculation: < 50ms for 100 sessions (with client-side date filtering)
- Render time: < 100ms total
- âš ï¸ Backend returns all sessions - client-side filtering required

**Optimization Techniques**:
1. Single-pass algorithm (O(n) where n = total sets)
2. Map for O(1) lookups
3. Early returns for invalid data
4. Memoize calculation results

**Test Scenarios**:
- 100 sessions, ~500 sets: Should complete < 50ms
- 300 sessions, ~1500 sets: Should complete < 100ms

**Source**: [Performance Strategy - Optimization Techniques, Performance Budgets]

### Analytics Event Schema
**Event: "Dashboard Card Viewed"**
```typescript
analytics.track('Dashboard Card Viewed', {
  cardType: 'prs',
  hasData: boolean,
  prCount: number,
  dateRange: string,
  timestamp: string
});
```

**Source**: [Analytics Integration - Event Taxonomy]

### Testing Requirements

**Unit Tests** (Jest):
- `calculatePersonalRecords()` with various data sets
- Edge cases: bodyweight exercises, missing data
- Sorting and top 5 selection
- Recent PR detection (< 7 days)
- Relative date formatting

**Integration Tests** (Testing Library + MSW):
- Card renders with PRs
- Empty state displays correctly
- ğŸ”¥ icon shows for recent PRs
- Date filter integration
- Analytics event fires

**Performance Tests**:
- Measure calculation time with 100, 300 sessions
- Document results

**Test File Locations**:
- `__tests__/lib/stats/personal-records.test.ts`
- `__tests__/components/dashboard/PersonalRecordsCard.test.tsx`

**Source**: [Testing Strategy - Unit Tests, Integration Tests]

### Empty State Design
**When to Show**: No PRs found in selected date range (new user or no workouts)

**Design**:
- Trophy icon (ğŸ†) - large, centered
- Message: "Your personal records will appear here"
- Motivational text: "Track your first workout to set your baseline!"
- No CTA needed (global CTAs on dashboard)

**Source**: [Component Architecture - Dashboard Components]

## Testing

### Test Coverage Requirements
- Unit test coverage: > 90% for PR calculation logic
- Integration test coverage: All card states

### Test Scenarios
1. **No PRs**: New user â†’ Empty state
2. **Single PR**: One exercise â†’ Shows in list
3. **Multiple PRs**: 5+ exercises â†’ Shows top 5, sorted by volume
4. **Recent PR**: PR within 7 days â†’ ğŸ”¥ icon displayed
5. **Old PR**: PR > 7 days â†’ Regular icon
6. **Date Filter**: Change range â†’ PRs recalculated
7. **Performance**: 300 sessions â†’ Calculation < 100ms

### Performance Targets
- PR calculation (100 sessions with filtering): < 50ms
- PR calculation (300 sessions with filtering): < 100ms
- Total render time: < 150ms
- âš ï¸ Backend returns all sessions - client-side filtering required

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation with complete references | Bob (SM) |
| 2025-10-12 | 1.1 | Story completed - All tasks implemented with 47 tests passing | James (Dev) |
| 2025-10-13 | 1.2 | Fixed API usage to `/api/workout-log`; added `lib/services/sessions.ts` normalizer; added `/api/exercise/{id}` proxy and client cache to resolve exercise names; cards switched to `['sessions','all']`; full QA with real data | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 via Cursor

### Debug Log References
```bash
# Tests executed
npm test -- __tests__/lib/stats/personal-records.test.ts __tests__/components/dashboard/PersonalRecordsCard.test.tsx
# Result: 47/47 tests passing

# Full test suite
npm test
# Result: 121/121 tests passing (100% pass rate)

# Linting
npm run lint
# Result: 0 errors in new files
```

### Completion Notes List

1. **Personal Records Calculation Logic** (`lib/stats/personal-records.ts`)
   - `calculatePersonalRecords()` - Finds max weight Ã— reps per exercise
   - Single-pass algorithm with Map for O(1) lookups
   - Returns top 5 PRs sorted by volume descending
   - Filters out bodyweight exercises and incomplete sets
   - Tracks isRecent flag for PRs < 7 days old
   - `formatRelativeDate()` - Smart date formatting (Today, Yesterday, X days ago, MMM d)
   - `formatWeight()` - Weight formatting with unit (kg/lbs)

2. **PersonalRecordsCard Component** (`components/dashboard/PersonalRecordsCard.tsx`)
   - Displays top 5 personal records in list format
   - Shows Flame icon (ğŸ”¥) for recent PRs (< 7 days), Dumbbell icon for older PRs
   - Each PR shows: Exercise name, weight Ã— reps, relative date, volume badge
   - Integrates with DateRangeContext for global filter
   - React Query integration (shares cache with TrainingVolumeCard)
   - Uses `fetchAllSessionsNormalized({ warnTag: 'PersonalRecordsCard' })`
   - Loading, error, and empty states all implemented

3. **Empty State Implementation**
   - Trophy icon with message "Your personal records will appear here"
   - Motivational text: "Track your first workout to set your baseline!"
   - No additional CTA (keeps focus on dashboard)
   - Gracefully handles 404 from backend `/workout-log`

4. **Analytics Integration**
   - Event: "Dashboard Card Viewed" fires on mount
   - Properties: cardType: 'prs', hasData, prCount, dateRange, timestamp
   - Follows console.log pattern from Story 1.1

5. **Performance Optimization**
   - Single-pass algorithm: O(n) where n = total sets
   - Map for O(1) exercise lookups
   - useMemo prevents unnecessary recalculation
   - Performance tested: < 50ms for 100 sessions (500 sets)

6. **Comprehensive Testing** (47 tests total - all passing)
   - 27 unit tests for PR calculation logic
     - Empty data handling, single/multiple exercises
     - Multiple sessions with same exercise
     - Recent PR detection (< 7 days)
     - Edge cases: bodyweight, missing data
     - Sorting and top 5 selection
     - Date/weight formatting utilities
   - 20 integration tests for component
     - Loading, error, empty states
     - PR rendering with icons
     - Flame icon for recent PRs
     - Dumbbell icon for old PRs
     - Analytics integration
     - Date range integration

7. **Dashboard Integration**
   - Replaced second DashboardCardSkeleton with PersonalRecordsCard
   - Positioned in top-right of 2x2 grid (per wireframes)
   - Shares React Query cache with TrainingVolumeCard (efficient)

8. **Brand Consistency**
   - Flame icon: Brand-orange (#FF6B00) for recent PRs
   - Dumbbell icon: Muted-foreground for older PRs
   - Card title icon: Brand-blue (#0B87D9)
   - Follows design system from Story 1.0

### File List

**Created:**
- `lib/stats/personal-records.ts` - PR calculation logic (145 lines)
- `components/dashboard/PersonalRecordsCard.tsx` - Card component (210 lines)
- `__tests__/lib/stats/personal-records.test.ts` - Unit tests (450 lines)
- `__tests__/components/dashboard/PersonalRecordsCard.test.tsx` - Integration tests (380 lines)

**Modified:**
- `app/app/page.tsx` - Integrated PersonalRecordsCard (replaced second skeleton)
- `docs/stories/1.5.personal-records-card.md` - Updated status and tasks

### ğŸ”´ CRITICAL: API Endpoint Correction
**URGENT: Backend API uses `/workout-log` endpoint, not `/api/logs`**

- **Problem**: Stories were originally documented with incorrect `/api/logs` endpoint
- **Solution**: All API routes and implementations MUST use `/workout-log` endpoint
- **Impact**: Stories 1.2, 1.4, 1.5, 1.6, 1.7, 1.9, 1.10 need to be redone to use correct endpoint
- **Files to Update**:
  - `app/api/workout-log/route.ts` (create/rename from logs)
  - All fetch calls must use `/workout-log` instead of `/api/logs`
  - Update tests to mock correct endpoint

## QA Results
*(To be populated by QA agent after dev completion)*
9. **2025â€‘10â€‘13 Enhancements**
   - Added `/app/api/exercise/[id]` route to proxy backend exercise lookup
   - `lib/services/sessions.ts` enriches logs missing names by fetching once per `exerciseId` and caching
   - Optional debug: set `NEXT_PUBLIC_DEBUG_STATS=true` to print a safe shape summary (`[Stats Debug] sessions normalized ...`) in console for troubleshooting

### QA â€” How to validate (2025â€‘10â€‘13)
1) Log in with a user that has sessions and append `?range=all` to the dashboard URL.
2) Confirm Personal Records shows nonâ€‘empty list with realistic exercise names (no "Unknown Exercise").
3) Open DevTools Console and verify `[Stats Debug] sessions normalized` includes a positive `nameCacheSize` when names are enriched.
4) Verify PR items show correct weight Ã— reps, relative dates, and ğŸ”¥ icon for items within 7 days.
5) Temporarily simulate `/api/workout-log` failure â†’ card shows error/empty state without crashing.
6) Performance spotâ€‘check: list renders quickly even with 100+ sessions; no jank.
