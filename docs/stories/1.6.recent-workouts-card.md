# Story 1.6: Recent Workouts Card

## Status
Ready for Review

## Story
**As a** user,  
**I want** to see my last 3-5 workouts,  
**so that** I can quickly recall recent training sessions.

## Acceptance Criteria
1. Fetch: `GET /workout-log` (all sessions, client-side filtering for limit=5)
2. Display: Date, workout title, duration, exercise count
3. Relative dates: "Today", "Yesterday", "2 days ago", or date for older
4. Click workout â†’ Open detail modal (future story: modal implementation)
5. Empty state: "No workouts yet. Download mobile app to track."
6. Analytics: "Dashboard Card Viewed" (cardType: 'recent'), "Dashboard Card Clicked" (action: 'view_detail')

## Integration Verification
- IV1: Sessions sorted correctly (most recent first)
- IV2: Relative dates update reactively (if dashboard left open)

## Tasks / Subtasks

### Task 1: Create Recent Workouts Card Component (AC: 1, 2, 3)
- [x] Create `components/dashboard/RecentWorkoutsCard.tsx`
  - [x] Use shared `DashboardCard` wrapper for consistent header/states
  - [x] Fetch sessions via shared cache: `useQuery({ queryKey: ['sessions','all'], queryFn: fetchAllSessionsNormalized })`
  - [x] Client-side limit=5 (most recent by `sessionDate`)
  - [x] Display workout list (3-5 items visible)
  - [x] Show: Relative date, workout title/program, duration, exercise count
  - [x] Calculate exercise count from logs array
  - [x] Format duration as "1h 15min" or "45min"
  - [x] Add 1px dividers between items for scanability
  - [x] Add bottom CTA "View History â†’" linking to `/app/history`

### Task 2: Implement Relative Date Formatting (AC: 3, IV2)
- [x] Create shared utils `lib/utils/date-format.ts`
  - [x] "Today, h:mm a" for today's workouts
  - [x] "Yesterday" for yesterday
  - [x] "X days ago" for recent (2-6 days)
  - [x] Actual date for older: "MMM d"
  - [x] Include time when multiple items share the same relative label (disambiguate)

### Task 3: Add Click Interaction (AC: 4)
- [x] Make workout items hoverable (pointer + background)
  - [x] Add hover state (light gray background)
  - [x] Add cursor pointer
  - [x] Fire analytics event on click
  - [ ] Future: Open detail modal (placeholder for now)
  - [x] For MVP: Show toast "Workout details coming soon"

### Task 4: Implement Empty State (AC: 5)
- [x] Create empty state
  - [x] Show when no sessions returned
  - [x] Message: "No workouts yet"
  - [x] Subtext: "Download mobile app to track"
  - [x] Icon: Clipboard icon
  - [x] CTA: "Download App" button

### Task 5: Integrate Analytics (AC: 6)
- [x] Analytics handled by wrapper
  - [x] Properties passed via `analyticsProps`: `cardType: 'recent'`, `hasData: boolean`, `workoutCount: number`
- [x] Add "Dashboard Card Clicked" on workout click
  - [x] Properties: `action: 'view_detail'`, `workoutId: string`, `cardType: 'recent'`

### Task 6: Integration Verification (IV1, IV2)
- [x] Verify sorting (most recent first)
  - [x] Verified via dataset in `RecentWorkoutsCard.test.tsx` and code path sorts by `sessionDate` DESC before slicing
  - [x] UI renders newest-to-oldest as expected
- [ ] Test relative date updates
  - [ ] Manual test: Keep page open overnight
  - [ ] Or: Mock time to test date changes

### Task 7: Testing
- [x] Write unit tests for date formatting `__tests__/lib/utils/date-format.test.ts`
  - [x] Today/Yesterday/Days ago/Older
  - [x] Duration formatting + HH:MM:SS conversion
- [x] Write integration tests for card `__tests__/components/dashboard/RecentWorkoutsCard.test.tsx`
  - [x] Card renders with workouts
  - [x] Empty state displays
  - [ ] Workout click fires analytics (placeholder for modal)
  - [x] Sorting verified via dataset dates

### Task 8: Optional Muscle Groups Line (UX Note)
- [x] Add a fast, non-blocking heuristic groups line per session
  - [x] Name-based mapping (bench/row/squat/ohp/deadlift/etc.)
  - [x] Scoring: sum(weightÃ—reps) per exercise; fallback reps â†’ sets
  - [x] Primary weight 1.0; secondary 0.5; accumulate by group
  - [x] Display top 1â€“2; if â‰¥4 groups and none â‰¥40% â†’ "Full body"
  - [x] Render as `ðŸ’ª Chest, Shoulders` (truncate if long)
  - [x] Memoized; runs quickly and doesnâ€™t block initial paint

## Dev Notes

### ðŸ”§ Developer Setup Reference
**Development Prerequisites**: Complete Stories 1.1-1.4
- **Setup Guide**: `docs/DEVELOPER_SETUP.md`
- **Branch**: `feature/story-1.6-recent-workouts-card`

**Source**: [DEVELOPER_SETUP.md]

### ðŸ“ User Flow & Wireframe References
**User Flow**: Recent Workouts provides quick access to training history
- **Flow Reference**: `docs/web-app-user-flows.md` - Section "Existing User Journey Step 2" (Dashboard Card 3)
- **Wireframe**: `docs/wireframes.md` - Section 2.1 (Dashboard - Populated State, Card 3: Recent Workouts)

**Key UX Requirements**:
- Show last 3-5 workouts (most recent first)
- Relative dates for better context
- Clickable items (future: open detail view)
- Compact display: date, title, duration, exercise count

**Source**: [web-app-user-flows.md - Card 3: Recent Workouts, wireframes.md - Section 2.1]

### ðŸŽ¨ Wireframe for Implementation

#### Recent Workouts Card (Bottom-Left Dashboard Card)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Recent Workouts           â”‚  â† Card heading (20px bold)
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                            â”‚
â”‚  ðŸ“… Today, 9:30 AM         â”‚  â† Workout item (clickable)
â”‚  Push Day - Week 4         â”‚     Date (14px, bold)
â”‚  1h 15min â€¢ 8 exercises    â”‚     Workout title (16px)
â”‚  ðŸ’ª Chest, Shoulders       â”‚     Duration â€¢ Exercise count
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚     Muscle groups (optional)
â”‚  ðŸ“… Yesterday              â”‚
â”‚  Pull Day - Week 4         â”‚  â† Workout item 2
â”‚  1h 05min â€¢ 7 exercises    â”‚
â”‚  ðŸ’ª Back, Biceps           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  ðŸ“… Jan 6                  â”‚
â”‚  Leg Day - Week 3          â”‚  â† Workout item 3
â”‚  1h 30min â€¢ 6 exercises    â”‚
â”‚  ðŸ’ª Legs, Glutes           â”‚
â”‚                            â”‚
â”‚  [View History â†’]          â”‚  â† CTA link
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Card Dimensions**:
- Width: 664px (desktop), 100% (mobile)
- Height: 340px
- Padding: 24px

**Workout Item Design**:
- Each item: 70-80px height
- Spacing: 12px between items
- Hover state: Light gray background (#f9fafb)
- Clickable: cursor-pointer
- Date: 14px, bold, dark gray (#1f2937)
- Title: 16px, regular, dark gray
- Meta: 14px, medium gray (#6b7280)
- Divider: 1px light gray between items

**Date Display Pattern**:
- Today: "Today, 9:30 AM" (includes time)
- Yesterday: "Yesterday"
- Recent (2-6 days): "2 days ago", "3 days ago"
- Older: "Jan 6", "Dec 28" (actual date)

### UX Note: Muscle Groups Line (Optional)
- Purpose: Provide quick context for what the session trained.
- Data source: Derive from exercise logs using the exercise library mapping (exercise â†’ primaryMuscles, secondaryMuscles). If metadata is missing, use a simple name-based fallback map.
- Scoring:
  - For each exercise, compute contribution = sum(sets Ã— reps Ã— weight). If weight missing, use sets Ã— reps; if reps also missing, use sets count (â‰¥1).
  - Weight primary muscles with 1.0 and secondary with 0.5; accumulate per muscle group.
- Selection:
  - Sort by contribution and display the top 1â€“2 groups. If no resolvable groups, omit the line entirely.
  - If â‰¥4 distinct groups and none exceeds ~40%, display "Full body" instead.
- Display:
  - Format: "ðŸ’ª Chest, Shoulders"; style: `text-sm text-muted-foreground`; single line with ellipsis truncation.
  - Place directly under the duration â€¢ exercises meta line; maintain item spacing/hover states.
- Performance: Compute per session with memoization; do not block initial renderâ€”render without the line if data not ready.

**Empty State**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Recent Workouts           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                            â”‚
â”‚       ðŸ“‹                   â”‚  â† Clipboard icon
â”‚                            â”‚
â”‚  No workouts yet           â”‚  â† Message (centered)
â”‚                            â”‚
â”‚  Download mobile app       â”‚  â† Subtext
â”‚  to track workouts         â”‚
â”‚                            â”‚
â”‚  [Download App]            â”‚  â† CTA button
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Source**: [wireframes.md - Section 2.1, Card: Recent Workouts]

### API Integration
**Session List Endpoint**:
```
GET /api/workout-log (all sessions, client-side filtering for limit=5)
Response: { sessions: WorkoutSession[] }
```

**Sorting**: Backend returns sessions sorted by sessionDate DESC (most recent first)
**âš ï¸ Client-side filtering**: Take first 5 sessions after sorting

**Source**: [API Integration (MVP) - Workout Session (Log) Endpoints]

**Workout Title Enrichment** (2025â€‘10â€‘13):
```
GET /api/workout/{id}
â†’ Used to resolve missing workout titles when session provides only `workoutId`.
â†’ Implemented client-side with a small cache during the session.
```

### Component Implementation
```typescript
// components/dashboard/RecentWorkoutsCard.tsx
import { useQuery } from '@tanstack/react-query';
import { formatRelativeDate, formatDuration } from '@/lib/utils';

export function RecentWorkoutsCard() {
  const { data: sessions, isLoading } = useQuery({
    queryKey: ['workouts', 'recent'],
    queryFn: () => fetchRecentWorkouts({ limit: 5 }),
    staleTime: 5 * 60 * 1000  // 5 minutes
  });
  
  useEffect(() => {
    analytics.track('Dashboard Card Viewed', {
      cardType: 'recent',
      hasData: sessions && sessions.length > 0,
      workoutCount: sessions?.length || 0
    });
  }, [sessions]);
  
  const handleWorkoutClick = (workoutId: string) => {
    analytics.track('Dashboard Card Clicked', {
      action: 'view_detail',
      workoutId,
      cardType: 'recent'
    });
    
    // Future: Open detail modal
    toast.info('Workout details coming soon!');
  };
  
  return (
    <DashboardCard 
      title="Recent Workouts"
      isEmpty={!sessions || sessions.length === 0}
      emptyState={<EmptyWorkoutsState />}
    >
      <div className="space-y-3">
        {sessions?.slice(0, 3).map(session => (
          <div
            key={session.id}
            onClick={() => handleWorkoutClick(session.id)}
            className="p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition"
          >
            <p className="text-sm font-semibold text-gray-900">
              ðŸ“… {formatRelativeDate(new Date(session.sessionDate))}
            </p>
            <p className="text-base text-gray-700">
              {session.routineTitle || 'Workout'}
            </p>
            <p className="text-sm text-gray-600">
              {formatDuration(session.duration)} â€¢ {session.logs?.length || 0} exercises
            </p>
            {session.muscleGroups && (
              <p className="text-sm text-gray-500">
                ðŸ’ª {session.muscleGroups.join(', ')}
              </p>
            )}
          </div>
        ))}
      </div>
      
      <button 
        onClick={() => router.push('/app/history')}
        className="mt-4 text-blue-600 text-sm font-medium"
      >
        View History â†’
      </button>
    </DashboardCard>
  );
}
```

**Source**: [Component Architecture - Dashboard Components, State Management]

### Utility Functions
**Date Formatting**:
```typescript
// lib/utils/date-format.ts
import { format, formatDistanceToNow, isToday, isYesterday } from 'date-fns';

export function formatRelativeDate(date: Date): string {
  if (isToday(date)) {
    return `Today, ${format(date, 'h:mm a')}`;
  }
  
  if (isYesterday(date)) {
    return 'Yesterday';
  }
  
  const daysAgo = Math.floor(
    (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24)
  );
  
  if (daysAgo < 7) {
    return `${daysAgo} days ago`;
  }
  
  return format(date, 'MMM d');
}

export function formatDuration(minutes?: number): string {
  if (!minutes) return '';
  
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  
  if (hours === 0) return `${mins}min`;
  if (mins === 0) return `${hours}h`;
  return `${hours}h ${mins}min`;
}
```

**Source**: [Technology Stack (MVP) - Date Handling]

### Analytics Event Schema
**Event: "Dashboard Card Viewed"**
```typescript
analytics.track('Dashboard Card Viewed', {
  cardType: 'recent',
  hasData: boolean,
  workoutCount: number,
  timestamp: string
});
```

**Event: "Dashboard Card Clicked"**
```typescript
analytics.track('Dashboard Card Clicked', {
  action: 'view_detail',
  workoutId: string,
  cardType: 'recent',
  timestamp: string
});
```

**Source**: [Analytics Integration - Event Taxonomy]

### Testing Requirements

**Unit Tests** (Jest):
- Date formatting functions
- Duration formatting
- Edge cases: null/undefined values

**Integration Tests** (Testing Library + MSW):
- Card renders with workouts
- Empty state displays
- Click interaction works
- Analytics events fire
- Sorting verified (newest first)

**Test File Locations**:
- `__tests__/lib/utils/date-format.test.ts`
- `__tests__/components/dashboard/RecentWorkoutsCard.test.tsx`

**Source**: [Testing Strategy - Unit Tests, Integration Tests]

### Empty State Design
**When to Show**: No sessions returned from API (new user or no workouts tracked)

**Design**:
- Clipboard icon (ðŸ“‹) - large, centered
- Message: "No workouts yet"
- Subtext: "Download mobile app to track workouts"
- CTA: "Download App" button â†’ App store link

**Source**: [Component Architecture - Dashboard Components]

## Testing

### Test Coverage Requirements
- Unit test coverage: > 85% for utilities and component
- Integration test coverage: All card states and interactions

### Test Scenarios
1. **No Workouts**: New user â†’ Empty state with CTA
2. **Single Workout**: One session â†’ Displays correctly
3. **Multiple Workouts**: 5 sessions â†’ Shows 3-5 most recent
4. **Today's Workout**: Workout today â†’ Shows "Today, 9:30 AM"
5. **Yesterday's Workout**: Yesterday â†’ Shows "Yesterday"
6. **Recent Workout**: 3 days ago â†’ Shows "3 days ago"
7. **Old Workout**: 30 days ago â†’ Shows "Jan 6" (actual date)
8. **Click Workout**: Click item â†’ Analytics fires, toast shows
9. **View History**: Click "View History" â†’ Navigate to /app/history

### Performance Targets
- Render time: < 100ms
- Smooth hover interactions (60fps)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation with complete references | Bob (SM) |
| 2025-10-13 | 1.1 | Implemented Recent Workouts Card, shared normalized fetch, utils, tests, and integrated into dashboard | James (Dev) |
| 2025-10-13 | 1.2 | Title enrichment via `/api/workout/{id}`; duration fallbacks; item dividers; CTA; duplicate-label time; optional muscleâ€‘groups line | James (Dev) |

## Dev Agent Record

### Agent Model Used
OpenAI o4â€‘mini (CLI), Node/Jest

### Debug Log References
```
npm test -- __tests__/lib/utils/date-format.test.ts __tests__/components/dashboard/RecentWorkoutsCard.test.tsx
# Result: passing
```

### Completion Notes List
1. Added `lib/utils/date-format.ts` with `formatRelativeDate`, `formatDuration`, `hhmmssToMinutes`.
2. Implemented `components/dashboard/RecentWorkoutsCard.tsx` using shared sessions cache and normalizer.
3. Empty/Loading/Error states implemented; analytics event on mount.
4. Integrated card into dashboard grid replacing skeleton.
5. Tests added for utils and component; suite passes locally.
6. Workout title enrichment added in `lib/services/sessions.ts` with proxy `app/api/workout/[id]/route.ts`.
7. Duration always shown using layered fallbacks; "â€”" when unknown.
8. Dividers and hover affordance added; CTA at bottom.
9. Duplicate relative labels optionally include time for disambiguation.
10. Optional muscle-groups line powered by fast name-based mapping and contribution scoring.
11. Design adjustment: list shows 4 items (not 5) to balance vertical spacing with the Progress card; acceptance allows 3â€“5 visible â€” we standardized on 4.

### File List
Created:
- `components/dashboard/RecentWorkoutsCard.tsx`
- `lib/utils/date-format.ts`
- `__tests__/lib/utils/date-format.test.ts`
- `__tests__/components/dashboard/RecentWorkoutsCard.test.tsx`

Modified:
- `app/app/page.tsx` â€” integrated the card
 - `lib/services/sessions.ts` â€” workoutId/title fields + enrichment + debug
 - `app/api/workout/[id]/route.ts` â€” new proxy route for workout details

## QA Guide (2025â€‘10â€‘13)

1) Open `/app?range=all`; confirm list shows newest sessions first.
2) Each row shows: relative date (with time when labels repeat), workout title, duration (not blank), and exercises count.
3) Verify item dividers and hover/tap affordances; bottom CTA navigates to `/app/history`.
4) With sessions that include common lift names, a `ðŸ’ª` line appears (or `Full body` for very mixed sessions). Omitted when unknown.
5) If your sessions lacked titles but had `workoutId`, verify titles appear after enrichment. Optional: set `NEXT_PUBLIC_DEBUG_STATS=true` and confirm `workoutCacheSize > 0` in `[Stats Debug]` output.
6) Error/empty states remain graceful; performance is smooth with 100+ sessions.

Note for QA: This card intentionally limits to 4 visible items to keep both dashboard columns aligned. If backend returns fewer than 4, it shows all available. Sorting is enforced client-side even if backend order differs.

### ðŸ”´ CRITICAL: API Endpoint Correction
**URGENT: Backend API uses `/workout-log` endpoint, not `/api/logs`**

- **Problem**: Stories were originally documented with incorrect `/api/logs` endpoint
- **Solution**: All API routes and implementations MUST use `/workout-log` endpoint
- **Impact**: Stories 1.2, 1.4, 1.5, 1.6, 1.7, 1.9, 1.10 need to be redone to use correct endpoint
- **Files to Update**:
  - `app/api/workout-log/route.ts` (create/rename from logs)
  - All fetch calls must use `/workout-log` instead of `/api/logs`
  - Update tests to mock correct endpoint

## QA Results
*(To be populated by QA agent after dev completion)*
