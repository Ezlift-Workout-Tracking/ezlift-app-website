# Pre-Implementation Assessment: Story 1.7 - Progress Over Time Card

**Date**: 2025-01-12  
**Reviewer**: Quinn (Test Architect)  
**Status**: DRAFT - Ready for Implementation  
**Assessment Type**: Proactive Quality Guidance  
**Complexity**: üî¥ **MEDIUM-HIGH**

---

## ‚úÖ Story Readiness Assessment

**Overall Readiness**: ‚ö†Ô∏è **READY WITH CAUTIONS**

Complex story with multiple moving parts (exercise selector, time range selector, 1RM calculations, interactive chart). Requires careful implementation and comprehensive testing.

---

## üß™ Test Design Recommendations

### Required Test Coverage

**Unit Tests** (Target: 30-35 tests):

1. **Epley Formula** (`lib/stats/one-rep-max.ts`):
   - ‚úÖ Known values: 100kg √ó 5 reps ‚Üí 116.7kg (verify formula)
   - ‚úÖ Known values: 80kg √ó 10 reps ‚Üí 106.7kg
   - ‚úÖ Edge case: 1 rep ‚Üí Returns actual weight
   - ‚úÖ Edge case: > 30 reps ‚Üí Returns weight (formula breaks)
   - ‚úÖ Edge case: 0 weight ‚Üí Returns 0
   - ‚úÖ Edge case: 0 reps ‚Üí Returns 0
   - ‚úÖ Bodyweight exercises ‚Üí Handle appropriately
   - ‚úÖ Fractional weights ‚Üí Proper rounding
   - ‚úÖ **CRITICAL**: Test accuracy with known real-world values

2. **Exercise Extraction** (`lib/utils/exercise-extraction.ts`):
   - ‚úÖ Extract unique exercises from sessions
   - ‚úÖ Count frequency per exercise
   - ‚úÖ Sort alphabetically by name
   - ‚úÖ Find most frequent exercise (default selection)
   - ‚úÖ Handle empty sessions
   - ‚úÖ Handle sessions with no exercises

3. **Progress Data Extraction**:
   - ‚úÖ Filter sessions for specific exercise
   - ‚úÖ Calculate max 1RM per session
   - ‚úÖ Sort by date ascending (chronological)
   - ‚úÖ Handle multiple sets of same exercise in one session
   - ‚úÖ Time range filtering (4w, 12w, 6m, 1y)

4. **Component Tests** (15+ tests):
   - ‚úÖ Exercise selector populated with user exercises
   - ‚úÖ Default selection: Most frequent exercise
   - ‚úÖ Chart renders with progress data
   - ‚úÖ Stats calculations correct (starting, current, change)
   - ‚úÖ Time range changes update chart
   - ‚úÖ Empty state: No exercise selected
   - ‚úÖ Empty state: No data for selected exercise
   - ‚úÖ Analytics events fire (view, exercise change, time range change)

---

## ‚ö†Ô∏è Risk Assessment

### High Risks

**RISK-PT-001: Epley Formula Accuracy** üî¥ **CRITICAL**
- **Risk**: Formula may not accurately represent user's true strength for all rep ranges
- **Probability**: Medium (formula is well-established but has limitations)
- **Impact**: High (users may distrust progress tracking)
- **Mitigation**:
  - **MUST TEST**: Validate formula with known 1RM values
  - Document formula limitations in UI (tooltip or help text)
  - Add disclaimer: "Estimated 1RM based on Epley formula"
  - Future: Allow manual 1RM entry
- **Priority**: **P0** - Test thoroughly before release

**RISK-PT-002: Chart Performance with Large Datasets** üü°
- **Risk**: 1 year of daily training = 365 data points may lag
- **Probability**: Low (IV2 already addresses this)
- **Impact**: Medium (chart sluggish or unresponsive)
- **Mitigation**:
  - Test with 50+ data points (IV2 requirement)
  - Implement data sampling if > 50 points
  - Use `isAnimationActive={false}` for large datasets
  - Consider lazy loading chart
- **Priority**: **P1** - Performance test required

### Medium Risks

**RISK-PT-003: Exercise Selector Overwhelming**
- **Risk**: Users with 100+ unique exercises = massive dropdown
- **Probability**: Medium (power users train many exercises)
- **Impact**: Medium (poor UX, hard to find exercises)
- **Mitigation**:
  - Add search/filter to dropdown (shadcn/ui Combobox)
  - Group by muscle group
  - Show frequency count: "Bench Press (trained 24 times)"
  - Limit to exercises trained ‚â•3 times
- **Priority**: **P2** - Consider for MVP if time allows

**RISK-PT-004: State Complexity**
- **Risk**: Two selectors (exercise + time range) = complex state management
- **Probability**: Low (React state straightforward)
- **Impact**: Medium (bugs in state updates)
- **Mitigation**:
  - Use controlled components
  - Comprehensive tests for state changes
  - Test all combinations of selections
- **Priority**: **P1** - Test thoroughly

### Low Risks

**RISK-PT-005: Empty States Confusion**
- **Risk**: Two different empty states may confuse users
- **Probability**: Low (messages are clear)
- **Impact**: Low (UX issue)
- **Mitigation**: Clear messaging for each state

---

## üèóÔ∏è NFR Recommendations

### Performance üî¥ **CRITICAL FOR THIS STORY**

**Targets**:
- 1RM calculation: < 50ms for 100 sessions
- Chart render: < 200ms with 50 data points
- Selector changes: Instant (< 50ms perceived)

**Performance Testing REQUIRED**:
```typescript
// __tests__/performance/progress-chart.perf.test.ts
describe('Performance: Progress Chart', () => {
  it('should calculate 1RM for 100 sessions < 50ms', () => {
    const sessions = generateTestSessions(100);
    const start = performance.now();
    
    const result = extractProgressData(sessions, 'bench-press');
    
    const duration = performance.now() - start;
    expect(duration).toBeLessThan(50);
  });
  
  it('should render chart with 50 points < 200ms', () => {
    // Measure React render time
  });
});
```

### Reliability

**Error Scenarios**:
1. ‚úÖ No exercises in user history ‚Üí Empty state with message
2. ‚úÖ Selected exercise no longer in filtered range ‚Üí Auto-select different exercise
3. ‚úÖ API failure ‚Üí Show error state, allow retry
4. ‚úÖ Calculation errors (NaN, Infinity) ‚Üí Skip that data point

### Maintainability

**Code Organization**:
- ‚úÖ **Separate Epley formula**: `lib/stats/one-rep-max.ts` (pure functions)
- ‚úÖ **Separate exercise utils**: `lib/utils/exercise-extraction.ts`
- ‚úÖ **Component stays presentational**: Minimal logic, calls utilities
- ‚úÖ **Comprehensive tests**: Critical for formula accuracy

---

## üí° Implementation Guidance

### Critical: Epley Formula Testing

**MUST VERIFY** with known values:

```typescript
describe('calculateEstimated1RM - Epley Formula', () => {
  it('should match known 1RM values', () => {
    // Real-world test cases
    expect(calculateEstimated1RM(100, 5)).toBeCloseTo(116.7, 1); // 100kg √ó 5 reps
    expect(calculateEstimated1RM(80, 10)).toBeCloseTo(106.7, 1); // 80kg √ó 10 reps
    expect(calculateEstimated1RM(60, 15)).toBeCloseTo(90, 1);    // 60kg √ó 15 reps
    expect(calculateEstimated1RM(120, 1)).toBe(120);             // Actual 1RM
  });
  
  it('should handle formula breakdown for high reps', () => {
    // Formula not accurate for > 30 reps
    expect(calculateEstimated1RM(50, 35)).toBe(50); // Return weight only
  });
});
```

**Reference**: Verify against online 1RM calculators before release

### Recommended State Structure

```typescript
interface ProgressChartState {
  selectedExercise: string | null;
  timeRange: '4w' | '12w' | '6m' | '1y';
  exercises: UniqueExercise[];
  progressData: ProgressDataPoint[];
  stats: ProgressStats | null;
}
```

**Use React hooks**:
- `useState` for selectedExercise, timeRange
- `useMemo` for exercises list, progressData, stats
- `useQuery` for sessions data

### Chart Optimization for Large Datasets

```typescript
// If > 50 data points, sample the data
const chartData = useMemo(() => {
  if (progressData.length <= 50) return progressData;
  
  // Sample every nth point to keep ~50 points
  const step = Math.ceil(progressData.length / 50);
  return progressData.filter((_, i) => i % step === 0);
}, [progressData]);
```

### Exercise Selector UX Enhancement

```typescript
// Show frequency in dropdown for better selection
<SelectItem value={ex.id}>
  {ex.name} <span className="text-gray-400">(trained {ex.frequency}√ó)</span>
</SelectItem>
```

---

## üéØ Acceptance Criteria Review

| AC # | Testable? | Complete? | Recommendation |
|------|-----------|-----------|----------------|
| AC1 | ‚úÖ Yes | ‚úÖ Complete | Good: Population from history specified |
| AC2 | ‚úÖ Yes | ‚úÖ Complete | Good: API endpoint specified |
| AC3 | ‚úÖ Yes | ‚úÖ Complete | **CRITICAL**: Must test formula accuracy |
| AC4 | ‚úÖ Yes | ‚úÖ Complete | Good: Chart specs detailed |
| AC5 | ‚ö†Ô∏è Unclear | ‚ö†Ô∏è Vague | **CLARIFY**: What makes data point "clickable"? Tooltip? Modal? |
| AC6 | ‚úÖ Yes | ‚úÖ Complete | Good: Stats format specified |
| AC7 | ‚úÖ Yes | ‚úÖ Complete | Good: Time range options listed |
| AC8 | ‚úÖ Yes | ‚úÖ Complete | Good: Empty state message provided |
| AC9 | ‚úÖ Yes | ‚úÖ Complete | Good: Analytics events specified |

**AC Quality**: ‚úÖ **GOOD** with two clarifications needed

**Recommendations**:
1. **AC3**: Add note about formula limitations (not accurate for > 12 reps)
2. **AC5**: Clarify "clickable" - Tooltip on hover? Click shows workout details? MVP scope?

---

## üìä Quality Predictions

**Expected Outcomes**:
- Test Coverage: 85-90% (complex logic requires thorough testing)
- Quality Score: 85-95 (depends on formula testing and performance)
- Implementation Time: ~6-8 hours (most complex dashboard card)
- Gate Decision: PASS if formula tested, CONCERNS if performance issues

**Complexity Factors**:
- üî¥ **High**: Epley formula accuracy critical
- üü° **Medium**: Exercise selector with large datasets
- üü° **Medium**: Chart performance with many data points
- üü¢ **Low**: Time range filtering (similar to Story 1.3)

---

## ‚úÖ Pre-Implementation Checklist

**Before Starting**:
- [ ] Research Epley formula limitations (literature review)
- [ ] Prepare test data with known 1RM values
- [ ] Decide on exercise selector max items (all? top 50?)
- [ ] Clarify AC5 clickable behavior
- [ ] Review Recharts LineChart documentation

**During Development**:
- [ ] Implement and TEST Epley formula first (TDD)
- [ ] Test with 50+ data points (IV2 requirement)
- [ ] Add performance monitoring (console.time)
- [ ] Implement data sampling for large datasets
- [ ] Test all time range options

**Before Review**:
- [ ] Formula verified with online 1RM calculators ‚úÖ
- [ ] Performance tested with 365 data points ‚úÖ
- [ ] Exercise selector tested with 100+ exercises ‚úÖ
- [ ] All state combinations tested ‚úÖ

---

**RECOMMENDATION**: ‚ö†Ô∏è **PROCEED WITH CAUTIONS**

Complex story requiring careful attention to:
1. **Epley formula accuracy** (CRITICAL)
2. **Chart performance** with large datasets
3. **Exercise selector UX** with many items

Expected gate: **PASS** if formula validated and performance tested, **CONCERNS** if testing insufficient.

**Priority Actions**:
1. Test Epley formula accuracy thoroughly
2. Performance test with 50+ data points
3. Consider exercise selector enhancements (search/filter)



