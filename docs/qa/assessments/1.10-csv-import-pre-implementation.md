# Pre-Implementation Assessment: Story 1.10 - CSV Import Flow

**Date**: 2025-01-12  
**Reviewer**: Quinn (Test Architect)  
**Status**: DRAFT - Ready for Implementation  
**Assessment Type**: Proactive Quality Guidance  
**Complexity**: ğŸ”´ **HIGH** (Most complex non-visual feature)

---

## âœ… Story Readiness Assessment

**Overall Readiness**: âš ï¸ **READY WITH SIGNIFICANT CAUTIONS**

This is the **most complex data processing story** in the MVP. Multiple failure points, data quality issues, and user experience challenges. Requires robust error handling and comprehensive testing.

---

## ğŸš¨ CRITICAL RISKS & PRIORITIES

### ğŸ”´ P0 Risks (MUST Address Before Release)

**RISK-IMP-001: Data Corruption from Bad Imports** ğŸ”´ **CRITICAL**
- **Risk**: Malformed CSV could create invalid workout sessions
- **Probability**: High (user-provided files are unpredictable)
- **Impact**: Critical (corrupted user data)
- **Mitigation**:
  - âœ… **MUST**: Validate ALL data before import
  - âœ… **MUST**: Use database transaction (rollback on failure)
  - âœ… **MUST**: Preview data before final import
  - âœ… **MUST**: Flag imported sessions (`isImported: true`)
  - âœ… **MUST**: Allow deletion of imported data
- **Testing**: Test with deliberately malformed CSVs, edge cases, max file sizes

**RISK-IMP-002: Exercise Fuzzy Matching Failures** ğŸ”´ **CRITICAL**
- **Risk**: >10% of exercises fail to match = poor user experience
- **Probability**: Medium (depends on exercise name variations)
- **Impact**: High (users lose significant historical data)
- **Mitigation**:
  - âœ… **MUST**: Test matching accuracy with real Hevy/Strong CSVs
  - âœ… **MUST**: Target â‰¥90% match rate (AC: IV2)
  - âœ… **MUST**: Show unmapped exercises for manual review
  - âœ… **MUST**: Allow user to map manually (future: AC suggestion)
  - âœ… **MUST**: Log unmapped exercises for improvement
- **Testing**: Test with 100+ unique exercise names from real exports

**RISK-IMP-003: Batch Import Performance & Reliability** ğŸ”´ **CRITICAL**
- **Risk**: Importing 500+ workouts could timeout, fail mid-process, or overwhelm API
- **Probability**: High (power users have extensive history)
- **Impact**: High (partial imports, data loss, poor UX)
- **Mitigation**:
  - âœ… **MUST**: Implement batch size limits (5-10 sessions per batch)
  - âœ… **MUST**: Add retry logic for failed batches
  - âœ… **MUST**: Continue on single failures (AC7)
  - âœ… **MUST**: Track failed imports for retry
  - âœ… **MUST**: Show progress bar (AC6)
  - âœ… **MUST**: Allow cancel during import
  - âœ… **MUST**: Test with 500+ session CSV
- **Testing**: Simulate network failures, API throttling, partial successes

### ğŸŸ¡ Medium Risks

**RISK-IMP-004: Memory Issues with Large CSVs**
- **Risk**: Parsing 10MB CSV in browser could cause memory spike
- **Probability**: Medium (Hevy exports can be large)
- **Impact**: Medium (browser lag, crash on low-end devices)
- **Mitigation**:
  - Implement file size limit (10MB in AC)
  - Stream parsing if PapaParse supports
  - Clear parsed data after review
  - Test on low-end devices
- **Priority**: **P1** - Test with max file size

**RISK-IMP-005: CSV Format Variations**
- **Risk**: Hevy may change CSV format, different export versions
- **Probability**: Medium (apps update formats)
- **Impact**: Medium (imports fail)
- **Mitigation**:
  - Document expected CSV structure
  - Add format detection/validation
  - Graceful error messages
  - Version detection if possible
- **Priority**: **P2** - Test with multiple Hevy export versions

---

## ğŸ§ª Test Design Recommendations

### CRITICAL Test Requirements

**Unit Tests** (Target: 40-50 tests):

1. **CSV Parser** (20+ tests):
   - âœ… Valid Hevy CSV â†’ Parsed correctly
   - âœ… Workout grouping by title + start_time + end_time
   - âœ… Exercise grouping within workouts
   - âœ… Set data extraction (weight, reps, rest time)
   - âœ… Missing columns â†’ Error or graceful skip
   - âœ… Malformed rows â†’ Skip with warning
   - âœ… Empty CSV â†’ Error message
   - âœ… Huge CSV (10MB) â†’ Parse without crash
   - âœ… Special characters in names â†’ Escaped properly
   - âœ… Date format variations â†’ Parsed correctly

2. **Exercise Fuzzy Matcher** (15+ tests):
   - âœ… Exact match â†’ 100% confidence
   - âœ… Typo match: "Bench Pres" â†’ "Bench Press"
   - âœ… Variation match: "BB Bench" â†’ "Barbell Bench Press"
   - âœ… No match â†’ Returns null, added to unmapped list
   - âœ… Match accuracy â‰¥90% on real Hevy exports (IV2)
   - âœ… Case insensitive matching
   - âœ… Whitespace handling

3. **Batch Importer** (10+ tests):
   - âœ… Successful batch import (all succeed)
   - âœ… Partial failure (3/5 succeed, 2 fail) - IV3
   - âœ… Complete failure (all fail)
   - âœ… Network timeout during import
   - âœ… Progress tracking updates
   - âœ… Cancel mid-import (cleanup)
   - âœ… Retry failed imports
   - âœ… Transaction rollback on critical errors

4. **Integration Tests** (10+ tests):
   - âœ… Complete flow: Upload â†’ Parse â†’ Review â†’ Import â†’ Success
   - âœ… Error at each stage â†’ Proper error messages
   - âœ… Cancel during import â†’ Cleanup
   - âœ… Dashboard refreshes after import (IV4)
   - âœ… User data state invalidated after import
   - âœ… Analytics funnel complete (all events)

### Test Data Requirements

**MUST HAVE**:
- âœ… Real Hevy CSV export (100-200 workouts)
- âœ… Real Strong CSV export (when format confirmed)
- âœ… Malformed CSVs (missing columns, bad dates)
- âœ… Large CSV (500+ workouts, ~5MB)
- âœ… Exercise name variations list
- âœ… Edge case CSVs (single workout, empty, max size)

---

## ğŸ—ï¸ NFR Recommendations

### Security ğŸ”´ **CRITICAL**

**File Upload Security**:
- âœ… **MUST**: Validate file type (CSV only)
- âœ… **MUST**: Enforce size limit (10MB)
- âœ… **MUST**: Scan for malicious content (CSV injection)
- âœ… **MUST**: Sanitize all user input before API calls
- âœ… **MUST**: Rate limit import API (prevent abuse)

**CSV Injection Prevention**:
```typescript
// Sanitize cell values starting with =, +, -, @
function sanitizeCSVCell(value: string): string {
  if (/^[=+\-@]/.test(value)) {
    return `'${value}`; // Prefix with quote
  }
  return value;
}
```

**API Security**:
- âœ… Validate session token on every import request
- âœ… Confirm user owns imported data
- âœ… Rate limit: Max 1 import per 5 minutes

### Performance

**Targets**:
- Parse 1000-row CSV: < 2 seconds
- Fuzzy match 100 exercises: < 500ms
- Import 100 workouts: < 30 seconds (with progress)
- UI remains responsive during import

**Recommendations**:
- Use Web Workers for CSV parsing (doesn't block UI)
- Batch API calls (5-10 sessions per request)
- Show progress every 10% (not every session)
- Implement request throttling (prevent API overload)

### Reliability ğŸ”´ **CRITICAL**

**Error Handling Matrix**:

| Stage | Error Type | User Action | System Response |
|-------|------------|-------------|-----------------|
| Upload | Invalid file type | Show error | "Please upload a CSV file" |
| Upload | File too large | Show error | "File must be < 10MB" |
| Parse | Malformed CSV | Show error | "CSV format not recognized" |
| Parse | Missing columns | Show warning | "Some columns missing, continuing..." |
| Match | Low match rate (<50%) | Show warning | "Many exercises not matched. Review?" |
| Import | API failure | Allow retry | "Import failed. Retry?" |
| Import | Partial failure | Show summary | "Imported X/Y workouts. Z failed." |
| Import | Network timeout | Allow resume | "Connection lost. Resume import?" |

**MUST IMPLEMENT**: Graceful degradation at every stage

---

## ğŸ’¡ Implementation Guidance

### Recommended Implementation Order

**Phase 1**: Parser (2-3 hours)
1. Implement CSV parser with PapaParse
2. Write 20+ tests for parsing
3. Test with real Hevy CSV
4. Handle malformed data gracefully

**Phase 2**: Matcher (2-3 hours)
1. Implement fuzzy matcher with MiniSearch
2. Write 15+ tests for matching
3. Test accuracy with real exercise names
4. Optimize threshold for â‰¥90% accuracy

**Phase 3**: UI Flow (3-4 hours)
1. Upload component with drag-drop
2. Review summary with unmapped list
3. Progress bar with cancel
4. Success screen with stats

**Phase 4**: Batch Importer (3-4 hours)
1. Implement batch API calls
2. Error handling and retry logic
3. Progress tracking
4. Dashboard cache invalidation

**Phase 5**: Testing (2-3 hours)
1. Integration tests for complete flow
2. Error scenario tests
3. Performance testing with large CSVs
4. Analytics funnel verification

**Total Estimate**: 12-17 hours (most complex story)

### Critical Code Patterns

**Error Handling**:
```typescript
async function batchImportSessions(sessions: WorkoutSession[]) {
  const results = { successful: 0, failed: 0, errors: [] };
  
  for (let i = 0; i < sessions.length; i++) {
    try {
      await importSession(sessions[i]);
      results.successful++;
      updateProgress((i + 1) / sessions.length * 100);
    } catch (error) {
      results.failed++;
      results.errors.push({ session: sessions[i].id, error: error.message });
      
      // CONTINUE with next session (AC7)
      console.error(`Failed to import session ${i}:`, error);
    }
  }
  
  return results;
}
```

**Fuzzy Matching**:
```typescript
import MiniSearch from 'minisearch';

const miniSearch = new MiniSearch({
  fields: ['name', 'alternateNames'],
  storeFields: ['id', 'name'],
  searchOptions: {
    fuzzy: 0.2,  // AC3 threshold
    prefix: true
  }
});

// Match exercise
function matchExercise(exerciseName: string): string | null {
  const results = miniSearch.search(exerciseName);
  
  if (results.length === 0) return null;
  if (results[0].score < 0.7) return null;  // Confidence threshold
  
  return results[0].id;
}
```

### Pitfalls to Avoid

âŒ **Don't**: Load entire CSV into memory at once (stream if possible)
âŒ **Don't**: Import all workouts in single API call (will timeout)
âŒ **Don't**: Block UI during parsing (use Web Worker or async)
âŒ **Don't**: Fail entire import if one session fails (continue with others)
âŒ **Don't**: Skip validation (malicious CSV could break system)
âŒ **Don't**: Forget to invalidate user data state cache after import

---

## ğŸ¯ Acceptance Criteria Review

| AC # | Testable? | Complete? | Recommendation |
|------|-----------|-----------|----------------|
| AC1 | âœ… Yes | âœ… Complete | Good: File upload specified |
| AC2 | âœ… Yes | âœ… Complete | Good: PapaParse specified |
| AC3 | âœ… Yes | âœ… Complete | Good: MiniSearch threshold specified (0.2) |
| AC4 | âœ… Yes | âœ… Complete | Good: Summary requirements clear |
| AC5 | âœ… Yes | âš ï¸ Unclear | **CLARIFY**: Single API call or batch? Batch size? |
| AC6 | âœ… Yes | âœ… Complete | Good: Progress bar specified |
| AC7 | âœ… Yes | âœ… Complete | **EXCELLENT**: Graceful failure handling |
| AC8 | âœ… Yes | âœ… Complete | Good: Success screen CTAs specified |
| AC9 | âœ… Yes | âœ… Complete | Good: Import metadata specified |
| AC10 | âœ… Yes | âœ… Complete | Good: Complete analytics funnel |

**AC Quality**: âœ… **VERY GOOD** with one clarification needed

**Critical Missing AC**:
- **Security**: No AC for CSV injection prevention (ADD THIS)
- **Validation**: No AC for data validation before import (ADD THIS)
- **Rollback**: No AC for "undo import" functionality (CONSIDER)

**Recommendations**:
1. **Add AC11**: "Validate CSV for malicious content (CSV injection prevention)"
2. **Add AC12**: "Provide 'Undo Import' functionality for X minutes after completion"
3. **Clarify AC5**: Specify batch size (recommend: 10 sessions per batch)

---

## âš ï¸ Comprehensive Risk Profile

### Security Risks ğŸ”´ **CRITICAL**

**SEC-001: CSV Injection Attack**
- **Scenario**: User uploads CSV with formula cells (=cmd|calc.exe)
- **Impact**: Code execution on user's machine when viewing in Excel
- **Mitigation**: Sanitize all cells starting with `=`, `+`, `-`, `@`
- **Priority**: **P0** - MUST implement before release

**SEC-002: File Upload Abuse**
- **Scenario**: Malicious user uploads 100MB file repeatedly
- **Impact**: Server resource exhaustion, DoS
- **Mitigation**: Enforce 10MB limit, rate limit imports (1 per 5 minutes)
- **Priority**: **P0** - MUST implement

**SEC-003: Data Validation**
- **Scenario**: Import creates invalid sessions (negative weights, future dates)
- **Impact**: Database integrity issues
- **Mitigation**: Validate all fields before API calls
- **Priority**: **P0** - MUST implement

### Reliability Risks ğŸŸ¡

**REL-001: Partial Import Failures**
- **Scenario**: Network drops mid-import (50/100 workouts imported)
- **Impact**: User has incomplete data, doesn't know which failed
- **Mitigation**: 
  - Track imported sessions in state
  - Show summary: "Imported 50/100. 50 failed."
  - Allow retry of failed only
  - Consider: Resume import capability
- **Priority**: **P1** - Implement retry logic

**REL-002: API Rate Limiting**
- **Scenario**: Backend rate limits import requests
- **Impact**: Import fails after X requests
- **Mitigation**:
  - Implement exponential backoff
  - Batch requests appropriately
  - Show "Slow import" message if rate limited
- **Priority**: **P1** - Handle gracefully

### Performance Risks ğŸŸ¡

**PERF-001: Browser Memory**
- **Scenario**: 10MB CSV parsed = high memory usage
- **Impact**: Browser lag or crash
- **Mitigation**: 
  - Clear parsed data after review
  - Stream parsing if possible
  - Test on mobile browsers
- **Priority**: **P1** - Test on low-end devices

**PERF-002: Fuzzy Matching Performance**
- **Scenario**: 500 exercises to match Ã— 1000 library exercises = slow
- **Impact**: "Processing..." screen hangs
- **Mitigation**:
  - Use MiniSearch indexing (pre-built)
  - Show progress during matching
  - Timeout after 30 seconds
- **Priority**: **P2** - Monitor performance

---

## ğŸ§ª Test Design Recommendations

### MUST-HAVE Tests (40-50 tests minimum)

**CSV Parser Tests** (20 tests):
```typescript
describe('CSV Parser - Hevy Format', () => {
  it('should parse valid Hevy CSV with 10 workouts', () => {
    const csv = loadTestFile('hevy-export-10-workouts.csv');
    const result = parseHevyCSV(csv);
    
    expect(result.workouts).toHaveLength(10);
    expect(result.workouts[0]).toMatchObject({
      title: expect.any(String),
      startTime: expect.any(Date),
      exercises: expect.any(Array)
    });
  });
  
  it('should handle malformed CSV gracefully', () => {
    const csv = 'title,start_time\nWorkout1,invalid-date';
    const result = parseHevyCSV(csv);
    
    expect(result.errors).toHaveLength(1);
    expect(result.errors[0]).toContain('Invalid date');
  });
  
  it('should handle missing columns', () => {
    const csv = 'title,exercise_title\nWorkout1,Bench Press';
    const result = parseHevyCSV(csv);
    
    expect(result.warnings).toContain('Missing required column: start_time');
  });
  
  // ... 17 more tests for edge cases
});
```

**Fuzzy Matcher Tests** (15 tests):
```typescript
describe('Exercise Fuzzy Matcher', () => {
  beforeAll(() => {
    // Initialize MiniSearch with exercise library
    initializeMatcher(exerciseLibrary);
  });
  
  it('should achieve â‰¥90% match rate on real Hevy export', () => {
    const heavyExercises = loadHeavyExerciseNames(); // 100+ names
    const matched = heavyExercises.filter(name => matchExercise(name) !== null);
    
    const matchRate = matched.length / heavyExercises.length;
    expect(matchRate).toBeGreaterThanOrEqual(0.90); // AC: IV2
  });
  
  it('should match with typos', () => {
    expect(matchExercise('Bench Pres')).toBe('bench-press-id');
    expect(matchExercise('Babell Squat')).toBe('barbell-squat-id');
  });
  
  it('should handle common abbreviations', () => {
    expect(matchExercise('BB Bench')).toBe('barbell-bench-press-id');
    expect(matchExercise('DB Curl')).toBe('dumbbell-curl-id');
  });
  
  // ... 12 more tests
});
```

**Batch Importer Tests** (10 tests):
```typescript
describe('Batch Importer', () => {
  it('should import sessions in batches of 10', async () => {
    const sessions = generateTestSessions(50);
    const onProgress = jest.fn();
    
    await batchImport(sessions, { batchSize: 10, onProgress });
    
    expect(onProgress).toHaveBeenCalledTimes(5); // 50/10 = 5 batches
  });
  
  it('should continue on single failure (AC7)', async () => {
    const sessions = [validSession, invalidSession, validSession];
    
    const result = await batchImport(sessions);
    
    expect(result.successful).toBe(2);
    expect(result.failed).toBe(1);
  });
  
  it('should allow cancel mid-import', async () => {
    const sessions = generateTestSessions(100);
    const abortController = new AbortController();
    
    setTimeout(() => abortController.abort(), 1000);
    
    const result = await batchImport(sessions, { signal: abortController.signal });
    
    expect(result.cancelled).toBe(true);
    expect(result.successful).toBeLessThan(100);
  });
  
  // ... 7 more tests
});
```

---

## ğŸ’¡ Implementation Guidance

### Phase 1: CSV Parsing (CRITICAL)

**MUST Test with Real Data**:
1. Get real Hevy CSV export (ask stakeholder or create account)
2. Document CSV structure (columns, format, edge cases)
3. Implement parser with comprehensive tests
4. Test with malformed CSVs

**PapaParse Configuration**:
```typescript
import Papa from 'papaparse';

function parseCSV(file: File): Promise<ParseResult> {
  return new Promise((resolve, reject) => {
    Papa.parse(file, {
      header: true,  // First row is header
      skipEmptyLines: true,
      transformHeader: (header) => header.trim().toLowerCase(),
      complete: (results) => {
        // Validate required columns
        const requiredColumns = ['title', 'start_time', 'end_time', 'exercise_title'];
        const missing = requiredColumns.filter(col => !results.meta.fields.includes(col));
        
        if (missing.length > 0) {
          reject(new Error(`Missing columns: ${missing.join(', ')}`));
          return;
        }
        
        resolve(processRows(results.data));
      },
      error: (error) => reject(error)
    });
  });
}
```

### Phase 2: Exercise Matching (CRITICAL)

**Test Match Accuracy**:
```typescript
// Create test fixture from real Hevy export
const heavyExerciseNames = [
  'Barbell Bench Press - Medium Grip',
  'BB Squat',
  'Deadlift (Barbell)',
  'DB Bicep Curl',
  // ... 100+ real names from export
];

// Test accuracy
const matchResults = heavyExerciseNames.map(name => ({
  original: name,
  matched: matchExercise(name),
  confidence: getMatchConfidence(name)
}));

const matchRate = matchResults.filter(r => r.matched !== null).length / matchResults.length;
console.log('Match rate:', matchRate); // MUST be â‰¥ 90%

// Log unmapped for improvement
const unmapped = matchResults.filter(r => r.matched === null);
console.log('Unmapped exercises:', unmapped);
```

### Phase 3: Batch Import (CRITICAL)

**Implement with Retry Logic**:
```typescript
async function importWithRetry(session: WorkoutSession, maxRetries = 3): Promise<Result> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      await fetch('/api/logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(session)
      });
      
      return { success: true };
    } catch (error) {
      if (attempt === maxRetries) {
        return { success: false, error };
      }
      
      // Exponential backoff
      await sleep(Math.pow(2, attempt) * 1000);
    }
  }
}
```

**Progress Tracking**:
```typescript
for (let i = 0; i < sessions.length; i++) {
  const result = await importWithRetry(sessions[i]);
  
  // Update every session (for accurate progress)
  const progress = ((i + 1) / sessions.length) * 100;
  setImportProgress({
    current: i + 1,
    total: sessions.length,
    percentage: progress,
    currentWorkout: sessions[i].title
  });
  
  // Update UI every 10% to reduce re-renders
  if (progress % 10 < (100 / sessions.length)) {
    forceUpdate();
  }
}
```

---

## ğŸ¯ Pre-Implementation Recommendations

### MUST DO Before Starting

**1. Security Audit**:
- [ ] Review CSV injection prevention
- [ ] Implement file validation
- [ ] Add rate limiting to API endpoint
- [ ] Test with malicious CSV files

**2. Test Data Preparation**:
- [ ] Get real Hevy CSV export (100+ workouts)
- [ ] Create malformed test CSVs
- [ ] Create large test CSV (500+ workouts)
- [ ] Document CSV format structure

**3. Performance Testing Plan**:
- [ ] Define performance budgets for each stage
- [ ] Prepare test scripts for 500+ workout imports
- [ ] Plan low-end device testing

**4. Error Handling Design**:
- [ ] Map all failure scenarios
- [ ] Design user-friendly error messages
- [ ] Plan retry/resume capabilities

---

## ğŸ“Š Quality Predictions

**Expected Outcomes**:
- Test Coverage: 80-85% (complex flow, many edge cases)
- Quality Score: 75-85 (high complexity, many risks)
- Implementation Time: 12-17 hours
- Gate Decision: **CONCERNS** if security/matching not tested, **PASS** if comprehensive

**Likely Gate Issues**:
- **Missing security tests** (CSV injection, file validation)
- **Insufficient matching accuracy** (< 90%)
- **Incomplete error handling** (not all scenarios covered)

**How to Achieve PASS**:
- Test with real Hevy CSVs
- Achieve â‰¥90% match rate
- Handle all error scenarios gracefully
- Comprehensive security testing
- 40+ tests covering all edge cases

---

**RECOMMENDATION**: âš ï¸ **PROCEED WITH EXTREME CAUTION**

This is the **highest-risk story** in Epic 1. Requires:
1. âœ… Security review and testing (CSV injection)
2. âœ… Real-world data testing (Hevy exports)
3. âœ… Performance testing (500+ workouts)
4. âœ… Comprehensive error handling
5. âœ… 40-50 tests minimum

Expected gate: **CONCERNS** if rushed, **PASS** if thorough.

**CRITICAL**: Budget 12-17 hours for this story, don't underestimate.



